<?php
defined("__POSEXEC") or die("No direct access allowed!");
/**
 * PuzzleOS
 * Build your own web-based application
 *
 * @package      maral.puzzleos.core
 * @author       Mohammad Ardika Rifqi <rifweb.android@gmail.com>
 * @copyright    2014-2017 MARAL INDUSTRIES
 *
 * @software     Release: 1.2.3
 */

/**
 * Handle Session more advanced than generic PHP
 * 
 * This class take these user info for verification:
 * HTTP_USER_AGENT
 * HTTP_REFERER
 * REMOTE_ADDR
 * cookie
 */
class PuzzleSession implements SessionHandlerInterface{
	
	/**
	 * $cnf structure
	 * [(bool)retain_on_same_pc=false,share_on_subdomain=false]
	 */
	private $cnf;
	
	/**
	 * $client structure
	 * [User Agent, Client IP, Domain which user is accessing]
	 */
	private $client;
	private $start_time;
	private $id;
	private $expire;
	private $destroyed;
	private $data;
	private $new_data;
	private $c_update;	

    public function open($savePath = "", $sessionName = ""){
		$this->destroyed = false;
		$this->new_data = true;
		$this->c_update = false;
		
		//1. Restore session id from cookie if exists
        if($_COOKIE["puzzleos"] != "") {
					
			//2. Restore all data and check if this session id is match with the real client
			//Session is constructed using cookie, http_host, and user_agent
			$data = Database::readAll("sessions","where session_id='?' limit 1", $_COOKIE["puzzleos"])->data[0];
			if($data["session_id"] != ""){
				
				//Session id exists in database, perform client checking
				$c = unserialize($data["cnf"]);
				$i = unserialize($data["client"]);
				
				if($i[3] === "NULL") {
					$i[3] = $_COOKIE["posfpv"];
					$this->c_update = true;
				}
				
				if($_SERVER["HTTP_USER_AGENT"] == $i[0] || $i[1] == $_SERVER["REMOTE_ADDR"]){
					if(($c[1] && (strpos($i[2],$_SERVER["HTTP_HOST"]) === false && strpos($_SERVER["HTTP_HOST"],$i[2]) === false)) || 
					(!$c[1] && $_SERVER["HTTP_HOST"] != $i[2]) && $i[3] == $_COOKIE["posfp"]){
						//Failed to verify user
					}else{
						//User verified
						$this->data = $data["content"];
						$this->cnf = $c;
						$this->client = $i;
						$this->expire = (int) $data["expire"] - $data["start"];
						session_id($_COOKIE["puzzleos"]);
						$this->id = $_COOKIE["puzzleos"];
						//Set the session_id()
						session_id($this->id);
						$this->new_data = false;
						return true;
					}
				}
			}
		}
		
		$this->client = [$_SERVER["HTTP_USER_AGENT"],$_SERVER["REMOTE_ADDR"],$_SERVER['HTTP_HOST'],"NULL"];
		$this->id = md5(json_encode([$this->client,time()]));
		$this->cnf = [0,false];
		
		/**
		 * Session will be expired in 1 hour if user do not open the browser again
		 * App can change this variable through service
		 */
		$this->expire = 60 * 60;
		$this->data = "";
		
		//Set the session_id()
		session_id($this->id);
		return true;
    }

    public function close(){}

    public function read($id){
		if($this->destroyed) throw new PuzzleError("Cannot read or write from destroyed session");
		return $this->data;
    }

    public function write($id, $data){
        if($this->destroyed) throw new PuzzleError("Cannot read or write from destroyed session");
		
		/* Only rewrite data when it's needed to */
		if($this->new_data){
			try{
				Database::newRow("sessions", $this->id, $data, serialize($this->client), serialize($this->cnf), time(), (int)time() + $this->expire, $_SESSION['account']['id']);
			}catch(DatabaseError $e){
				//For unknown reason, browser sent two or more request at the same time, which cause multiple session with same key to be created.
				//To overcome this problem, we will load that keys instead of creating new one
				$_COOKIE["puzzleos"] = $this->id;
				return self::open("","");
			}			
			$this->new_data = false;
		}else if(md5($this->data) != md5($data) || $this->c_update){
			$di = new DatabaseRowInput;
			$di->setField("content",$data);
			$di->setField("cnf",serialize($this->cnf));
			$di->setField("client",serialize($this->client));
			$di->setField("user",$_SESSION['account']['id']);
			Database::updateRowAdvanced("sessions",$di,"session_id",$this->id);
		}
		return true;
    }
	
	public function write_cookie(){
		if($this->destroyed) throw new PuzzleError("Cannot read or write from destroyed session");
		
		/**
		 * If HTTP host is localhost or IP address, then put NULL in setcookie()
		 * else, put ".domain.com"
		 */
		if($this->client[2]=="localhost" || filter_var($this->client[2], FILTER_VALIDATE_IP)){
			$root_domain = NULL;
		}else{
			$d_array = explode(".",$this->client[2]);
			$root_domain = end($d_array);
			$root_domain = "." . prev($d_array) . "." . $root_domain;
		}
		
		if($this->client[3] == "NULL"){
			Template::addHeader('<script>'.base64_decode("IWZ1bmN0aW9uKGUsdCxyKXsidXNlIHN0cmljdCI7ImZ1bmN0aW9uIj09dHlwZW9mIHdpbmRvdy5kZWZpbmUmJndpbmRvdy5kZWZpbmUuYW1kP3dpbmRvdy5kZWZpbmUocik6InVuZGVmaW5lZCIhPXR5cGVvZiBtb2R1bGUmJm1vZHVsZS5leHBvcnRzP21vZHVsZS5leHBvcnRzPXIoKTp0LmV4cG9ydHM/dC5leHBvcnRzPXIoKTp0LkZpbmdlcnByaW50Mj1yKCl9KDAsdGhpcyxmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgZT1mdW5jdGlvbih0KXtpZighKHRoaXMgaW5zdGFuY2VvZiBlKSlyZXR1cm4gbmV3IGUodCk7dGhpcy5vcHRpb25zPXRoaXMuZXh0ZW5kKHQse3N3ZkNvbnRhaW5lcklkOiJmaW5nZXJwcmludGpzMiIsc3dmUGF0aDoiZmxhc2gvY29tcGlsZWQvRm9udExpc3Quc3dmIixkZXRlY3RTY3JlZW5PcmllbnRhdGlvbjohMCxzb3J0UGx1Z2luc0ZvcjpbL3BhbGVtb29uL2ldLHVzZXJEZWZpbmVkRm9udHM6W10sZXhjbHVkZURvTm90VHJhY2s6ITAsZXhjbHVkZVBpeGVsUmF0aW86ITB9KSx0aGlzLm5hdGl2ZUZvckVhY2g9QXJyYXkucHJvdG90eXBlLmZvckVhY2gsdGhpcy5uYXRpdmVNYXA9QXJyYXkucHJvdG90eXBlLm1hcH07cmV0dXJuIGUucHJvdG90eXBlPXtleHRlbmQ6ZnVuY3Rpb24oZSx0KXtpZihudWxsPT1lKXJldHVybiB0O2Zvcih2YXIgciBpbiBlKW51bGwhPWVbcl0mJnRbcl0hPT1lW3JdJiYodFtyXT1lW3JdKTtyZXR1cm4gdH0sZ2V0OmZ1bmN0aW9uKGUpe3ZhciB0PXRoaXMscj17ZGF0YTpbXSxhZGRQcmVwcm9jZXNzZWRDb21wb25lbnQ6ZnVuY3Rpb24oZSl7dmFyIG49ZS52YWx1ZTsiZnVuY3Rpb24iPT10eXBlb2YgdC5vcHRpb25zLnByZXByb2Nlc3NvciYmKG49dC5vcHRpb25zLnByZXByb2Nlc3NvcihlLmtleSxuKSksci5kYXRhLnB1c2goe2tleTplLmtleSx2YWx1ZTpufSl9fTtyPXRoaXMudXNlckFnZW50S2V5KHIpLHI9dGhpcy5sYW5ndWFnZUtleShyKSxyPXRoaXMuY29sb3JEZXB0aEtleShyKSxyPXRoaXMuZGV2aWNlTWVtb3J5S2V5KHIpLHI9dGhpcy5waXhlbFJhdGlvS2V5KHIpLHI9dGhpcy5oYXJkd2FyZUNvbmN1cnJlbmN5S2V5KHIpLHI9dGhpcy5zY3JlZW5SZXNvbHV0aW9uS2V5KHIpLHI9dGhpcy5hdmFpbGFibGVTY3JlZW5SZXNvbHV0aW9uS2V5KHIpLHI9dGhpcy50aW1lem9uZU9mZnNldEtleShyKSxyPXRoaXMuc2Vzc2lvblN0b3JhZ2VLZXkocikscj10aGlzLmxvY2FsU3RvcmFnZUtleShyKSxyPXRoaXMuaW5kZXhlZERiS2V5KHIpLHI9dGhpcy5hZGRCZWhhdmlvcktleShyKSxyPXRoaXMub3BlbkRhdGFiYXNlS2V5KHIpLHI9dGhpcy5jcHVDbGFzc0tleShyKSxyPXRoaXMucGxhdGZvcm1LZXkocikscj10aGlzLmRvTm90VHJhY2tLZXkocikscj10aGlzLnBsdWdpbnNLZXkocikscj10aGlzLmNhbnZhc0tleShyKSxyPXRoaXMud2ViZ2xLZXkocikscj10aGlzLndlYmdsVmVuZG9yQW5kUmVuZGVyZXJLZXkocikscj10aGlzLmFkQmxvY2tLZXkocikscj10aGlzLmhhc0xpZWRMYW5ndWFnZXNLZXkocikscj10aGlzLmhhc0xpZWRSZXNvbHV0aW9uS2V5KHIpLHI9dGhpcy5oYXNMaWVkT3NLZXkocikscj10aGlzLmhhc0xpZWRCcm93c2VyS2V5KHIpLHI9dGhpcy50b3VjaFN1cHBvcnRLZXkocikscj10aGlzLmN1c3RvbUVudHJvcHlGdW5jdGlvbihyKSx0aGlzLmZvbnRzS2V5KHIsZnVuY3Rpb24ocil7dmFyIG49W107dC5lYWNoKHIuZGF0YSxmdW5jdGlvbihlKXt2YXIgdD1lLnZhbHVlO3QmJiJmdW5jdGlvbiI9PXR5cGVvZiB0LmpvaW4mJih0PXQuam9pbigiOyIpKSxuLnB1c2godCl9KTt2YXIgaT10Lng2NGhhc2gxMjgobi5qb2luKCJ+fn4iKSwzMSk7cmV0dXJuIGUoaSxyLmRhdGEpfSl9LGN1c3RvbUVudHJvcHlGdW5jdGlvbjpmdW5jdGlvbihlKXtyZXR1cm4iZnVuY3Rpb24iPT10eXBlb2YgdGhpcy5vcHRpb25zLmN1c3RvbUZ1bmN0aW9uJiZlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJjdXN0b20iLHZhbHVlOnRoaXMub3B0aW9ucy5jdXN0b21GdW5jdGlvbigpfSksZX0sdXNlckFnZW50S2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZVVzZXJBZ2VudHx8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToidXNlcl9hZ2VudCIsdmFsdWU6dGhpcy5nZXRVc2VyQWdlbnQoKX0pLGV9LGdldFVzZXJBZ2VudDpmdW5jdGlvbigpe3JldHVybiBuYXZpZ2F0b3IudXNlckFnZW50fSxsYW5ndWFnZUtleTpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVMYW5ndWFnZXx8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToibGFuZ3VhZ2UiLHZhbHVlOm5hdmlnYXRvci5sYW5ndWFnZXx8bmF2aWdhdG9yLnVzZXJMYW5ndWFnZXx8bmF2aWdhdG9yLmJyb3dzZXJMYW5ndWFnZXx8bmF2aWdhdG9yLnN5c3RlbUxhbmd1YWdlfHwiIn0pLGV9LGNvbG9yRGVwdGhLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlQ29sb3JEZXB0aHx8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiY29sb3JfZGVwdGgiLHZhbHVlOndpbmRvdy5zY3JlZW4uY29sb3JEZXB0aHx8LTF9KSxlfSxkZXZpY2VNZW1vcnlLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlRGV2aWNlTWVtb3J5fHxlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJkZXZpY2VfbWVtb3J5Iix2YWx1ZTp0aGlzLmdldERldmljZU1lbW9yeSgpfSksZX0sZ2V0RGV2aWNlTWVtb3J5OmZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5kZXZpY2VNZW1vcnl8fC0xfSxwaXhlbFJhdGlvS2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZVBpeGVsUmF0aW98fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6InBpeGVsX3JhdGlvIix2YWx1ZTp0aGlzLmdldFBpeGVsUmF0aW8oKX0pLGV9LGdldFBpeGVsUmF0aW86ZnVuY3Rpb24oKXtyZXR1cm4gd2luZG93LmRldmljZVBpeGVsUmF0aW98fCIifSxzY3JlZW5SZXNvbHV0aW9uS2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZVNjcmVlblJlc29sdXRpb24/ZTp0aGlzLmdldFNjcmVlblJlc29sdXRpb24oZSl9LGdldFNjcmVlblJlc29sdXRpb246ZnVuY3Rpb24oZSl7dmFyIHQ7cmV0dXJuIHQ9dGhpcy5vcHRpb25zLmRldGVjdFNjcmVlbk9yaWVudGF0aW9uJiZ3aW5kb3cuc2NyZWVuLmhlaWdodD53aW5kb3cuc2NyZWVuLndpZHRoP1t3aW5kb3cuc2NyZWVuLmhlaWdodCx3aW5kb3cuc2NyZWVuLndpZHRoXTpbd2luZG93LnNjcmVlbi53aWR0aCx3aW5kb3cuc2NyZWVuLmhlaWdodF0sZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToicmVzb2x1dGlvbiIsdmFsdWU6dH0pLGV9LGF2YWlsYWJsZVNjcmVlblJlc29sdXRpb25LZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlQXZhaWxhYmxlU2NyZWVuUmVzb2x1dGlvbj9lOnRoaXMuZ2V0QXZhaWxhYmxlU2NyZWVuUmVzb2x1dGlvbihlKX0sZ2V0QXZhaWxhYmxlU2NyZWVuUmVzb2x1dGlvbjpmdW5jdGlvbihlKXt2YXIgdDtyZXR1cm4gd2luZG93LnNjcmVlbi5hdmFpbFdpZHRoJiZ3aW5kb3cuc2NyZWVuLmF2YWlsSGVpZ2h0JiYodD10aGlzLm9wdGlvbnMuZGV0ZWN0U2NyZWVuT3JpZW50YXRpb24/d2luZG93LnNjcmVlbi5hdmFpbEhlaWdodD53aW5kb3cuc2NyZWVuLmF2YWlsV2lkdGg/W3dpbmRvdy5zY3JlZW4uYXZhaWxIZWlnaHQsd2luZG93LnNjcmVlbi5hdmFpbFdpZHRoXTpbd2luZG93LnNjcmVlbi5hdmFpbFdpZHRoLHdpbmRvdy5zY3JlZW4uYXZhaWxIZWlnaHRdOlt3aW5kb3cuc2NyZWVuLmF2YWlsSGVpZ2h0LHdpbmRvdy5zY3JlZW4uYXZhaWxXaWR0aF0pLHZvaWQgMCE9PXQmJmUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6ImF2YWlsYWJsZV9yZXNvbHV0aW9uIix2YWx1ZTp0fSksZX0sdGltZXpvbmVPZmZzZXRLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlVGltZXpvbmVPZmZzZXR8fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6InRpbWV6b25lX29mZnNldCIsdmFsdWU6KG5ldyBEYXRlKS5nZXRUaW1lem9uZU9mZnNldCgpfSksZX0sc2Vzc2lvblN0b3JhZ2VLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIXRoaXMub3B0aW9ucy5leGNsdWRlU2Vzc2lvblN0b3JhZ2UmJnRoaXMuaGFzU2Vzc2lvblN0b3JhZ2UoKSYmZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToic2Vzc2lvbl9zdG9yYWdlIix2YWx1ZToxfSksZX0sbG9jYWxTdG9yYWdlS2V5OmZ1bmN0aW9uKGUpe3JldHVybiF0aGlzLm9wdGlvbnMuZXhjbHVkZVNlc3Npb25TdG9yYWdlJiZ0aGlzLmhhc0xvY2FsU3RvcmFnZSgpJiZlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJsb2NhbF9zdG9yYWdlIix2YWx1ZToxfSksZX0saW5kZXhlZERiS2V5OmZ1bmN0aW9uKGUpe3JldHVybiF0aGlzLm9wdGlvbnMuZXhjbHVkZUluZGV4ZWREQiYmdGhpcy5oYXNJbmRleGVkREIoKSYmZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiaW5kZXhlZF9kYiIsdmFsdWU6MX0pLGV9LGFkZEJlaGF2aW9yS2V5OmZ1bmN0aW9uKGUpe3JldHVybiF0aGlzLm9wdGlvbnMuZXhjbHVkZUFkZEJlaGF2aW9yJiZkb2N1bWVudC5ib2R5JiZkb2N1bWVudC5ib2R5LmFkZEJlaGF2aW9yJiZlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJhZGRfYmVoYXZpb3IiLHZhbHVlOjF9KSxlfSxvcGVuRGF0YWJhc2VLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIXRoaXMub3B0aW9ucy5leGNsdWRlT3BlbkRhdGFiYXNlJiZ3aW5kb3cub3BlbkRhdGFiYXNlJiZlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJvcGVuX2RhdGFiYXNlIix2YWx1ZToxfSksZX0sY3B1Q2xhc3NLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlQ3B1Q2xhc3N8fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6ImNwdV9jbGFzcyIsdmFsdWU6dGhpcy5nZXROYXZpZ2F0b3JDcHVDbGFzcygpfSksZX0scGxhdGZvcm1LZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlUGxhdGZvcm18fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6Im5hdmlnYXRvcl9wbGF0Zm9ybSIsdmFsdWU6dGhpcy5nZXROYXZpZ2F0b3JQbGF0Zm9ybSgpfSksZX0sZG9Ob3RUcmFja0tleTpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVEb05vdFRyYWNrfHxlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJkb19ub3RfdHJhY2siLHZhbHVlOnRoaXMuZ2V0RG9Ob3RUcmFjaygpfSksZX0sY2FudmFzS2V5OmZ1bmN0aW9uKGUpe3JldHVybiF0aGlzLm9wdGlvbnMuZXhjbHVkZUNhbnZhcyYmdGhpcy5pc0NhbnZhc1N1cHBvcnRlZCgpJiZlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJjYW52YXMiLHZhbHVlOnRoaXMuZ2V0Q2FudmFzRnAoKX0pLGV9LHdlYmdsS2V5OmZ1bmN0aW9uKGUpe3JldHVybiF0aGlzLm9wdGlvbnMuZXhjbHVkZVdlYkdMJiZ0aGlzLmlzV2ViR2xTdXBwb3J0ZWQoKSYmZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToid2ViZ2wiLHZhbHVlOnRoaXMuZ2V0V2ViZ2xGcCgpfSksZX0sd2ViZ2xWZW5kb3JBbmRSZW5kZXJlcktleTpmdW5jdGlvbihlKXtyZXR1cm4hdGhpcy5vcHRpb25zLmV4Y2x1ZGVXZWJHTFZlbmRvckFuZFJlbmRlcmVyJiZ0aGlzLmlzV2ViR2xTdXBwb3J0ZWQoKSYmZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToid2ViZ2xfdmVuZG9yIix2YWx1ZTp0aGlzLmdldFdlYmdsVmVuZG9yQW5kUmVuZGVyZXIoKX0pLGV9LGFkQmxvY2tLZXk6ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlQWRCbG9ja3x8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiYWRibG9jayIsdmFsdWU6dGhpcy5nZXRBZEJsb2NrKCl9KSxlfSxoYXNMaWVkTGFuZ3VhZ2VzS2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZUhhc0xpZWRMYW5ndWFnZXN8fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6Imhhc19saWVkX2xhbmd1YWdlcyIsdmFsdWU6dGhpcy5nZXRIYXNMaWVkTGFuZ3VhZ2VzKCl9KSxlfSxoYXNMaWVkUmVzb2x1dGlvbktleTpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVIYXNMaWVkUmVzb2x1dGlvbnx8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiaGFzX2xpZWRfcmVzb2x1dGlvbiIsdmFsdWU6dGhpcy5nZXRIYXNMaWVkUmVzb2x1dGlvbigpfSksZX0saGFzTGllZE9zS2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZUhhc0xpZWRPc3x8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiaGFzX2xpZWRfb3MiLHZhbHVlOnRoaXMuZ2V0SGFzTGllZE9zKCl9KSxlfSxoYXNMaWVkQnJvd3NlcktleTpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVIYXNMaWVkQnJvd3Nlcnx8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiaGFzX2xpZWRfYnJvd3NlciIsdmFsdWU6dGhpcy5nZXRIYXNMaWVkQnJvd3NlcigpfSksZX0sZm9udHNLZXk6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVKc0ZvbnRzP3RoaXMuZmxhc2hGb250c0tleShlLHQpOnRoaXMuanNGb250c0tleShlLHQpfSxmbGFzaEZvbnRzS2V5OmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHRoaXMub3B0aW9ucy5leGNsdWRlRmxhc2hGb250cz90KGUpOnRoaXMuaGFzU3dmT2JqZWN0TG9hZGVkKCkmJnRoaXMuaGFzTWluRmxhc2hJbnN0YWxsZWQoKT92b2lkIDA9PT10aGlzLm9wdGlvbnMuc3dmUGF0aD90KGUpOnZvaWQgdGhpcy5sb2FkU3dmQW5kRGV0ZWN0Rm9udHMoZnVuY3Rpb24ocil7ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToic3dmX2ZvbnRzIix2YWx1ZTpyLmpvaW4oIjsiKX0pLHQoZSl9KTp0KGUpfSxqc0ZvbnRzS2V5OmZ1bmN0aW9uKGUsdCl7dmFyIHI9dGhpcztyZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpe3ZhciBuPVsibW9ub3NwYWNlIiwic2Fucy1zZXJpZiIsInNlcmlmIl0saT1bIkFuZGFsZSBNb25vIiwiQXJpYWwiLCJBcmlhbCBCbGFjayIsIkFyaWFsIEhlYnJldyIsIkFyaWFsIE1UIiwiQXJpYWwgTmFycm93IiwiQXJpYWwgUm91bmRlZCBNVCBCb2xkIiwiQXJpYWwgVW5pY29kZSBNUyIsIkJpdHN0cmVhbSBWZXJhIFNhbnMgTW9ubyIsIkJvb2sgQW50aXF1YSIsIkJvb2ttYW4gT2xkIFN0eWxlIiwiQ2FsaWJyaSIsIkNhbWJyaWEiLCJDYW1icmlhIE1hdGgiLCJDZW50dXJ5IiwiQ2VudHVyeSBHb3RoaWMiLCJDZW50dXJ5IFNjaG9vbGJvb2siLCJDb21pYyBTYW5zIiwiQ29taWMgU2FucyBNUyIsIkNvbnNvbGFzIiwiQ291cmllciIsIkNvdXJpZXIgTmV3IiwiR2VuZXZhIiwiR2VvcmdpYSIsIkhlbHZldGljYSIsIkhlbHZldGljYSBOZXVlIiwiSW1wYWN0IiwiTHVjaWRhIEJyaWdodCIsIkx1Y2lkYSBDYWxsaWdyYXBoeSIsIkx1Y2lkYSBDb25zb2xlIiwiTHVjaWRhIEZheCIsIkxVQ0lEQSBHUkFOREUiLCJMdWNpZGEgSGFuZHdyaXRpbmciLCJMdWNpZGEgU2FucyIsIkx1Y2lkYSBTYW5zIFR5cGV3cml0ZXIiLCJMdWNpZGEgU2FucyBVbmljb2RlIiwiTWljcm9zb2Z0IFNhbnMgU2VyaWYiLCJNb25hY28iLCJNb25vdHlwZSBDb3JzaXZhIiwiTVMgR290aGljIiwiTVMgT3V0bG9vayIsIk1TIFBHb3RoaWMiLCJNUyBSZWZlcmVuY2UgU2FucyBTZXJpZiIsIk1TIFNhbnMgU2VyaWYiLCJNUyBTZXJpZiIsIk1ZUklBRCIsIk1ZUklBRCBQUk8iLCJQYWxhdGlubyIsIlBhbGF0aW5vIExpbm90eXBlIiwiU2Vnb2UgUHJpbnQiLCJTZWdvZSBTY3JpcHQiLCJTZWdvZSBVSSIsIlNlZ29lIFVJIExpZ2h0IiwiU2Vnb2UgVUkgU2VtaWJvbGQiLCJTZWdvZSBVSSBTeW1ib2wiLCJUYWhvbWEiLCJUaW1lcyIsIlRpbWVzIE5ldyBSb21hbiIsIlRpbWVzIE5ldyBSb21hbiBQUyIsIlRyZWJ1Y2hldCBNUyIsIlZlcmRhbmEiLCJXaW5nZGluZ3MiLCJXaW5nZGluZ3MgMiIsIldpbmdkaW5ncyAzIl07ci5vcHRpb25zLmV4dGVuZGVkSnNGb250cyYmKGk9aS5jb25jYXQoWyJBYmFkaSBNVCBDb25kZW5zZWQgTGlnaHQiLCJBY2FkZW15IEVuZ3JhdmVkIExFVCIsIkFET0JFIENBU0xPTiBQUk8iLCJBZG9iZSBHYXJhbW9uZCIsIkFET0JFIEdBUkFNT05EIFBSTyIsIkFnZW5jeSBGQiIsIkFoYXJvbmkiLCJBbGJlcnR1cyBFeHRyYSBCb2xkIiwiQWxiZXJ0dXMgTWVkaXVtIiwiQWxnZXJpYW4iLCJBbWF6b25lIEJUIiwiQW1lcmljYW4gVHlwZXdyaXRlciIsIkFtZXJpY2FuIFR5cGV3cml0ZXIgQ29uZGVuc2VkIiwiQW1lclR5cGUgTWQgQlQiLCJBbmRhbHVzIiwiQW5nc2FuYSBOZXciLCJBbmdzYW5hVVBDIiwiQW50aXF1ZSBPbGl2ZSIsIkFwYXJhaml0YSIsIkFwcGxlIENoYW5jZXJ5IiwiQXBwbGUgQ29sb3IgRW1vamkiLCJBcHBsZSBTRCBHb3RoaWMgTmVvIiwiQXJhYmljIFR5cGVzZXR0aW5nIiwiQVJDSEVSIiwiQVJOTyBQUk8iLCJBcnJ1cyBCVCIsIkF1cm9yYSBDbiBCVCIsIkF2YW50R2FyZGUgQmsgQlQiLCJBdmFudEdhcmRlIE1kIEJUIiwiQVZFTklSIiwiQXl1dGhheWEiLCJCYW5keSIsIkJhbmdsYSBTYW5nYW0gTU4iLCJCYW5rIEdvdGhpYyIsIkJhbmtHb3RoaWMgTWQgQlQiLCJCYXNrZXJ2aWxsZSIsIkJhc2tlcnZpbGxlIE9sZCBGYWNlIiwiQmF0YW5nIiwiQmF0YW5nQ2hlIiwiQmF1ZXIgQm9kb25pIiwiQmF1aGF1cyA5MyIsIkJhem9va2EiLCJCZWxsIE1UIiwiQmVtYm8iLCJCZW5ndWlhdCBCayBCVCIsIkJlcmxpbiBTYW5zIEZCIiwiQmVybGluIFNhbnMgRkIgRGVtaSIsIkJlcm5hcmQgTVQgQ29uZGVuc2VkIiwiQmVybmhhcmRGYXNoaW9uIEJUIiwiQmVybmhhcmRNb2QgQlQiLCJCaWcgQ2FzbG9uIiwiQmlubmVyRCIsIkJsYWNrYWRkZXIgSVRDIiwiQmxhaXJNZElUQyBUVCIsIkJvZG9uaSA3MiIsIkJvZG9uaSA3MiBPbGRzdHlsZSIsIkJvZG9uaSA3MiBTbWFsbGNhcHMiLCJCb2RvbmkgTVQiLCJCb2RvbmkgTVQgQmxhY2siLCJCb2RvbmkgTVQgQ29uZGVuc2VkIiwiQm9kb25pIE1UIFBvc3RlciBDb21wcmVzc2VkIiwiQm9va3NoZWxmIFN5bWJvbCA3IiwiQm91bGRlciIsIkJyYWRsZXkgSGFuZCIsIkJyYWRsZXkgSGFuZCBJVEMiLCJCcmVtZW4gQmQgQlQiLCJCcml0YW5uaWMgQm9sZCIsIkJyb2Fkd2F5IiwiQnJvd2FsbGlhIE5ldyIsIkJyb3dhbGxpYVVQQyIsIkJydXNoIFNjcmlwdCBNVCIsIkNhbGlmb3JuaWFuIEZCIiwiQ2FsaXN0byBNVCIsIkNhbGxpZ3JhcGhlciIsIkNhbmRhcmEiLCJDYXNsb25PcG5mYWNlIEJUIiwiQ2FzdGVsbGFyIiwiQ2VudGF1ciIsIkNlemFubmUiLCJDRyBPbWVnYSIsIkNHIFRpbWVzIiwiQ2hhbGtib2FyZCIsIkNoYWxrYm9hcmQgU0UiLCJDaGFsa2R1c3RlciIsIkNoYXJsZXN3b3J0aCIsIkNoYXJ0ZXIgQmQgQlQiLCJDaGFydGVyIEJUIiwiQ2hhdWNlciIsIkNoZWx0aG1JVEMgQmsgQlQiLCJDaGlsbGVyIiwiQ2xhcmVuZG9uIiwiQ2xhcmVuZG9uIENvbmRlbnNlZCIsIkNsb2lzdGVyQmxhY2sgQlQiLCJDb2NoaW4iLCJDb2xvbm5hIE1UIiwiQ29uc3RhbnRpYSIsIkNvb3BlciBCbGFjayIsIkNvcHBlcnBsYXRlIiwiQ29wcGVycGxhdGUgR290aGljIiwiQ29wcGVycGxhdGUgR290aGljIEJvbGQiLCJDb3BwZXJwbGF0ZSBHb3RoaWMgTGlnaHQiLCJDb3BwZXJwbEdvdGggQmQgQlQiLCJDb3JiZWwiLCJDb3JkaWEgTmV3IiwiQ29yZGlhVVBDIiwiQ29ybmVyc3RvbmUiLCJDb3JvbmV0IiwiQ3Vja29vIiwiQ3VybHogTVQiLCJEYXVuUGVuaCIsIkRhdXBoaW4iLCJEYXZpZCIsIkRCIExDRCBUZW1wIiwiREVMSUNJT1VTIiwiRGVubWFyayIsIkRGS2FpLVNCIiwiRGlkb3QiLCJEaWxsZW5pYVVQQyIsIkRJTiIsIkRva0NoYW1wYSIsIkRvdHVtIiwiRG90dW1DaGUiLCJFYnJpbWEiLCJFZHdhcmRpYW4gU2NyaXB0IElUQyIsIkVsZXBoYW50IiwiRW5nbGlzaCAxMTEgVml2YWNlIEJUIiwiRW5ncmF2ZXJzIE1UIiwiRW5ncmF2ZXJzR290aGljIEJUIiwiRXJhcyBCb2xkIElUQyIsIkVyYXMgRGVtaSBJVEMiLCJFcmFzIExpZ2h0IElUQyIsIkVyYXMgTWVkaXVtIElUQyIsIkV1Y3Jvc2lhVVBDIiwiRXVwaGVtaWEiLCJFdXBoZW1pYSBVQ0FTIiwiRVVST1NUSUxFIiwiRXhvdGMzNTAgQmQgQlQiLCJGYW5nU29uZyIsIkZlbGl4IFRpdGxpbmciLCJGaXhlZHN5cyIsIkZPTlRJTiIsIkZvb3RsaWdodCBNVCBMaWdodCIsIkZvcnRlIiwiRnJhbmtSdWVobCIsIkZyYW5zaXNjYW4iLCJGcmVlZnJtNzIxIEJsayBCVCIsIkZyZWVzaWFVUEMiLCJGcmVlc3R5bGUgU2NyaXB0IiwiRnJlbmNoIFNjcmlwdCBNVCIsIkZybmtHb3RoSVRDIEJrIEJUIiwiRnJ1aXRnZXIiLCJGUlVUSUdFUiIsIkZ1dHVyYSIsIkZ1dHVyYSBCayBCVCIsIkZ1dHVyYSBMdCBCVCIsIkZ1dHVyYSBNZCBCVCIsIkZ1dHVyYSBaQmxrIEJUIiwiRnV0dXJhQmxhY2sgQlQiLCJHYWJyaW9sYSIsIkdhbGxpYXJkIEJUIiwiR2F1dGFtaSIsIkdlZXphIFBybyIsIkdlb21ldHIyMzEgQlQiLCJHZW9tZXRyMjMxIEh2IEJUIiwiR2VvbWV0cjIzMSBMdCBCVCIsIkdlb1NsYWIgNzAzIEx0IEJUIiwiR2VvU2xhYiA3MDMgWEJkIEJUIiwiR2lnaSIsIkdpbGwgU2FucyIsIkdpbGwgU2FucyBNVCIsIkdpbGwgU2FucyBNVCBDb25kZW5zZWQiLCJHaWxsIFNhbnMgTVQgRXh0IENvbmRlbnNlZCBCb2xkIiwiR2lsbCBTYW5zIFVsdHJhIEJvbGQiLCJHaWxsIFNhbnMgVWx0cmEgQm9sZCBDb25kZW5zZWQiLCJHaXNoYSIsIkdsb3VjZXN0ZXIgTVQgRXh0cmEgQ29uZGVuc2VkIiwiR09USEFNIiwiR09USEFNIEJPTEQiLCJHb3VkeSBPbGQgU3R5bGUiLCJHb3VkeSBTdG91dCIsIkdvdWR5SGFuZHRvb2xlZCBCVCIsIkdvdWR5T0xTdCBCVCIsIkd1amFyYXRpIFNhbmdhbSBNTiIsIkd1bGltIiwiR3VsaW1DaGUiLCJHdW5nc3VoIiwiR3VuZ3N1aENoZSIsIkd1cm11a2hpIE1OIiwiSGFldHRlbnNjaHdlaWxlciIsIkhhcmxvdyBTb2xpZCBJdGFsaWMiLCJIYXJyaW5ndG9uIiwiSGVhdGhlciIsIkhlaXRpIFNDIiwiSGVpdGkgVEMiLCJIRUxWIiwiSGVyYWxkIiwiSGlnaCBUb3dlciBUZXh0IiwiSGlyYWdpbm8gS2FrdSBHb3RoaWMgUHJvTiIsIkhpcmFnaW5vIE1pbmNobyBQcm9OIiwiSG9lZmxlciBUZXh0IiwiSHVtYW5zdCA1MjEgQ24gQlQiLCJIdW1hbnN0NTIxIEJUIiwiSHVtYW5zdDUyMSBMdCBCVCIsIkltcHJpbnQgTVQgU2hhZG93IiwiSW5jaXNlZDkwMSBCZCBCVCIsIkluY2lzZWQ5MDEgQlQiLCJJbmNpc2VkOTAxIEx0IEJUIiwiSU5DT05TT0xBVEEiLCJJbmZvcm1hbCBSb21hbiIsIkluZm9ybWFsMDExIEJUIiwiSU5URVJTVEFURSIsIklyaXNVUEMiLCJJc2tvb2xhIFBvdGEiLCJKYXNtaW5lVVBDIiwiSmF6eiBMRVQiLCJKZW5zb24iLCJKZXN0ZXIiLCJKb2tlcm1hbiIsIkp1aWNlIElUQyIsIkthYmVsIEJrIEJUIiwiS2FiZWwgVWx0IEJUIiwiS2FpbGFzYSIsIkthaVRpIiwiS2FsaW5nYSIsIkthbm5hZGEgU2FuZ2FtIE1OIiwiS2FydGlrYSIsIkthdWZtYW5uIEJkIEJUIiwiS2F1Zm1hbm4gQlQiLCJLaG1lciBVSSIsIktvZGNoaWFuZ1VQQyIsIktva2lsYSIsIktvcmlubmEgQlQiLCJLcmlzdGVuIElUQyIsIktydW5ndGhlcCIsIkt1bnN0bGVyIFNjcmlwdCIsIkxhbyBVSSIsIkxhdGhhIiwiTGVlbGF3YWRlZSIsIkxldHRlciBHb3RoaWMiLCJMZXZlbmltIE1UIiwiTGlseVVQQyIsIkxpdGhvZ3JhcGgiLCJMaXRob2dyYXBoIExpZ2h0IiwiTG9uZyBJc2xhbmQiLCJMeWRpYW4gQlQiLCJNYWduZXRvIiwiTWFpYW5kcmEgR0QiLCJNYWxheWFsYW0gU2FuZ2FtIE1OIiwiTWFsZ3VuIEdvdGhpYyIsIk1hbmdhbCIsIk1hcmlnb2xkIiwiTWFyaW9uIiwiTWFya2VyIEZlbHQiLCJNYXJrZXQiLCJNYXJsZXR0IiwiTWF0aXNzZSBJVEMiLCJNYXR1cmEgTVQgU2NyaXB0IENhcGl0YWxzIiwiTWVpcnlvIiwiTWVpcnlvIFVJIiwiTWljcm9zb2Z0IEhpbWFsYXlhIiwiTWljcm9zb2Z0IEpoZW5nSGVpIiwiTWljcm9zb2Z0IE5ldyBUYWkgTHVlIiwiTWljcm9zb2Z0IFBoYWdzUGEiLCJNaWNyb3NvZnQgVGFpIExlIiwiTWljcm9zb2Z0IFVpZ2h1ciIsIk1pY3Jvc29mdCBZYUhlaSIsIk1pY3Jvc29mdCBZaSBCYWl0aSIsIk1pbmdMaVUiLCJNaW5nTGlVX0hLU0NTIiwiTWluZ0xpVV9IS1NDUy1FeHRCIiwiTWluZ0xpVS1FeHRCIiwiTWluaW9uIiwiTWluaW9uIFBybyIsIk1pcmlhbSIsIk1pcmlhbSBGaXhlZCIsIk1pc3RyYWwiLCJNb2Rlcm4iLCJNb2Rlcm4gTm8uIDIwIiwiTW9uYSBMaXNhIFNvbGlkIElUQyBUVCIsIk1vbmdvbGlhbiBCYWl0aSIsIk1PTk8iLCJNb29sQm9yYW4iLCJNcnMgRWF2ZXMiLCJNUyBMaW5lRHJhdyIsIk1TIE1pbmNobyIsIk1TIFBNaW5jaG8iLCJNUyBSZWZlcmVuY2UgU3BlY2lhbHR5IiwiTVMgVUkgR290aGljIiwiTVQgRXh0cmEiLCJNVVNFTyIsIk1WIEJvbGkiLCJOYWRlZW0iLCJOYXJraXNpbSIsIk5FVklTIiwiTmV3cyBHb3RoaWMiLCJOZXdzIEdvdGhpY01UIiwiTmV3c0dvdGggQlQiLCJOaWFnYXJhIEVuZ3JhdmVkIiwiTmlhZ2FyYSBTb2xpZCIsIk5vdGV3b3J0aHkiLCJOU2ltU3VuIiwiTnlhbGEiLCJPQ1IgQSBFeHRlbmRlZCIsIk9sZCBDZW50dXJ5IiwiT2xkIEVuZ2xpc2ggVGV4dCBNVCIsIk9ueXgiLCJPbnl4IEJUIiwiT1BUSU1BIiwiT3JpeWEgU2FuZ2FtIE1OIiwiT1NBS0EiLCJPekhhbmRpY3JhZnQgQlQiLCJQYWxhY2UgU2NyaXB0IE1UIiwiUGFweXJ1cyIsIlBhcmNobWVudCIsIlBhcnR5IExFVCIsIlBlZ2FzdXMiLCJQZXJwZXR1YSIsIlBlcnBldHVhIFRpdGxpbmcgTVQiLCJQZXRpdGFCb2xkIiwiUGlja3dpY2siLCJQbGFudGFnZW5ldCBDaGVyb2tlZSIsIlBsYXliaWxsIiwiUE1pbmdMaVUiLCJQTWluZ0xpVS1FeHRCIiwiUG9vciBSaWNoYXJkIiwiUG9zdGVyIiwiUG9zdGVyQm9kb25pIEJUIiwiUFJJTkNFVE9XTiBMRVQiLCJQcmlzdGluYSIsIlBUQmFybnVtIEJUIiwiUHl0aGFnb3JhcyIsIlJhYXZpIiwiUmFnZSBJdGFsaWMiLCJSYXZpZSIsIlJpYmJvbjEzMSBCZCBCVCIsIlJvY2t3ZWxsIiwiUm9ja3dlbGwgQ29uZGVuc2VkIiwiUm9ja3dlbGwgRXh0cmEgQm9sZCIsIlJvZCIsIlJvbWFuIiwiU2Fra2FsIE1hamFsbGEiLCJTYW50YSBGZSBMRVQiLCJTYXZveWUgTEVUIiwiU2NlcHRyZSIsIlNjcmlwdCIsIlNjcmlwdCBNVCBCb2xkIiwiU0NSSVBUSU5BIiwiU2VyaWZhIiwiU2VyaWZhIEJUIiwiU2VyaWZhIFRoIEJUIiwiU2hlbGxleVZvbGFudGUgQlQiLCJTaGVyd29vZCIsIlNob25hciBCYW5nbGEiLCJTaG93Y2FyZCBHb3RoaWMiLCJTaHJ1dGkiLCJTaWduYm9hcmQiLCJTSUxLU0NSRUVOIiwiU2ltSGVpIiwiU2ltcGxpZmllZCBBcmFiaWMiLCJTaW1wbGlmaWVkIEFyYWJpYyBGaXhlZCIsIlNpbVN1biIsIlNpbVN1bi1FeHRCIiwiU2luaGFsYSBTYW5nYW0gTU4iLCJTa2V0Y2ggUm9ja3dlbGwiLCJTa2lhIiwiU21hbGwgRm9udHMiLCJTbmFwIElUQyIsIlNuZWxsIFJvdW5kaGFuZCIsIlNvY2tldCIsIlNvdXZlbmlyIEx0IEJUIiwiU3RhY2NhdG8yMjIgQlQiLCJTdGVhbWVyIiwiU3RlbmNpbCIsIlN0b3J5Ym9vayIsIlN0eWxsbyIsIlN1YndheSIsIlN3aXM3MjEgQmxrRXggQlQiLCJTd2lzczkxMSBYQ20gQlQiLCJTeWxmYWVuIiwiU3luY2hybyBMRVQiLCJTeXN0ZW0iLCJUYW1pbCBTYW5nYW0gTU4iLCJUZWNobmljYWwiLCJUZWxldHlwZSIsIlRlbHVndSBTYW5nYW0gTU4iLCJUZW1wdXMgU2FucyBJVEMiLCJUZXJtaW5hbCIsIlRob25idXJpIiwiVHJhZGl0aW9uYWwgQXJhYmljIiwiVHJhamFuIiwiVFJBSkFOIFBSTyIsIlRyaXN0YW4iLCJUdWJ1bGFyIiwiVHVuZ2EiLCJUdyBDZW4gTVQiLCJUdyBDZW4gTVQgQ29uZGVuc2VkIiwiVHcgQ2VuIE1UIENvbmRlbnNlZCBFeHRyYSBCb2xkIiwiVHlwb1VwcmlnaHQgQlQiLCJVbmljb3JuIiwiVW5pdmVycyIsIlVuaXZlcnMgQ0UgNTUgTWVkaXVtIiwiVW5pdmVycyBDb25kZW5zZWQiLCJVdHNhYWgiLCJWYWdhYm9uZCIsIlZhbmkiLCJWaWpheWEiLCJWaW5lciBIYW5kIElUQyIsIlZpc3VhbFVJIiwiVml2YWxkaSIsIlZsYWRpbWlyIFNjcmlwdCIsIlZyaW5kYSIsIldlc3RtaW5zdGVyIiwiV0hJVE5FWSIsIldpZGUgTGF0aW4iLCJaYXBmRWxsaXB0IEJUIiwiWmFwZkh1bW5zdCBCVCIsIlphcGZIdW1uc3QgRG0gQlQiLCJaYXBmaW5vIiwiWnVyaWNoIEJsa0V4IEJUIiwiWnVyaWNoIEV4IEJUIiwiWldBZG9iZUYiXSkpLGk9KGk9aS5jb25jYXQoci5vcHRpb25zLnVzZXJEZWZpbmVkRm9udHMpKS5maWx0ZXIoZnVuY3Rpb24oZSx0KXtyZXR1cm4gaS5pbmRleE9mKGUpPT09dH0pO3ZhciBhPWRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0sbz1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSxzPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLGw9e30sZD17fSxoPWZ1bmN0aW9uKCl7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpO3JldHVybiBlLnN0eWxlLnBvc2l0aW9uPSJhYnNvbHV0ZSIsZS5zdHlsZS5sZWZ0PSItOTk5OXB4IixlLnN0eWxlLmZvbnRTaXplPSI3MnB4IixlLnN0eWxlLmZvbnRTdHlsZT0ibm9ybWFsIixlLnN0eWxlLmZvbnRXZWlnaHQ9Im5vcm1hbCIsZS5zdHlsZS5sZXR0ZXJTcGFjaW5nPSJub3JtYWwiLGUuc3R5bGUubGluZUJyZWFrPSJhdXRvIixlLnN0eWxlLmxpbmVIZWlnaHQ9Im5vcm1hbCIsZS5zdHlsZS50ZXh0VHJhbnNmb3JtPSJub25lIixlLnN0eWxlLnRleHRBbGlnbj0ibGVmdCIsZS5zdHlsZS50ZXh0RGVjb3JhdGlvbj0ibm9uZSIsZS5zdHlsZS50ZXh0U2hhZG93PSJub25lIixlLnN0eWxlLndoaXRlU3BhY2U9Im5vcm1hbCIsZS5zdHlsZS53b3JkQnJlYWs9Im5vcm1hbCIsZS5zdHlsZS53b3JkU3BhY2luZz0ibm9ybWFsIixlLmlubmVySFRNTD0ibW1tbW1tbW1tbWxsaSIsZX0sYz1mdW5jdGlvbihlKXtmb3IodmFyIHQ9ITEscj0wO3I8bi5sZW5ndGg7cisrKWlmKHQ9ZVtyXS5vZmZzZXRXaWR0aCE9PWxbbltyXV18fGVbcl0ub2Zmc2V0SGVpZ2h0IT09ZFtuW3JdXSlyZXR1cm4gdDtyZXR1cm4gdH0sdT1mdW5jdGlvbigpe2Zvcih2YXIgZT1bXSx0PTAscj1uLmxlbmd0aDt0PHI7dCsrKXt2YXIgaT1oKCk7aS5zdHlsZS5mb250RmFtaWx5PW5bdF0sby5hcHBlbmRDaGlsZChpKSxlLnB1c2goaSl9cmV0dXJuIGV9KCk7YS5hcHBlbmRDaGlsZChvKTtmb3IodmFyIGc9MCxwPW4ubGVuZ3RoO2c8cDtnKyspbFtuW2ddXT11W2ddLm9mZnNldFdpZHRoLGRbbltnXV09dVtnXS5vZmZzZXRIZWlnaHQ7dmFyIG09ZnVuY3Rpb24oKXtmb3IodmFyIGUsdCxyLGE9e30sbz0wLGw9aS5sZW5ndGg7bzxsO28rKyl7Zm9yKHZhciBkPVtdLGM9MCx1PW4ubGVuZ3RoO2M8dTtjKyspe3ZhciBnPShlPWlbb10sdD1uW2NdLHI9dm9pZCAwLChyPWgoKSkuc3R5bGUuZm9udEZhbWlseT0iJyIrZSsiJywiK3Qscik7cy5hcHBlbmRDaGlsZChnKSxkLnB1c2goZyl9YVtpW29dXT1kfXJldHVybiBhfSgpO2EuYXBwZW5kQ2hpbGQocyk7Zm9yKHZhciBmPVtdLFM9MCxUPWkubGVuZ3RoO1M8VDtTKyspYyhtW2lbU11dKSYmZi5wdXNoKGlbU10pO2EucmVtb3ZlQ2hpbGQocyksYS5yZW1vdmVDaGlsZChvKSxlLmFkZFByZXByb2Nlc3NlZENvbXBvbmVudCh7a2V5OiJqc19mb250cyIsdmFsdWU6Zn0pLHQoZSl9LDEpfSxwbHVnaW5zS2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZVBsdWdpbnN8fCh0aGlzLmlzSUUoKT90aGlzLm9wdGlvbnMuZXhjbHVkZUlFUGx1Z2luc3x8ZS5hZGRQcmVwcm9jZXNzZWRDb21wb25lbnQoe2tleToiaWVfcGx1Z2lucyIsdmFsdWU6dGhpcy5nZXRJRVBsdWdpbnMoKX0pOmUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6InJlZ3VsYXJfcGx1Z2lucyIsdmFsdWU6dGhpcy5nZXRSZWd1bGFyUGx1Z2lucygpfSkpLGV9LGdldFJlZ3VsYXJQbHVnaW5zOmZ1bmN0aW9uKCl7dmFyIGU9W107aWYobmF2aWdhdG9yLnBsdWdpbnMpZm9yKHZhciB0PTAscj1uYXZpZ2F0b3IucGx1Z2lucy5sZW5ndGg7dDxyO3QrKyluYXZpZ2F0b3IucGx1Z2luc1t0XSYmZS5wdXNoKG5hdmlnYXRvci5wbHVnaW5zW3RdKTtyZXR1cm4gdGhpcy5wbHVnaW5zU2hvdWxkQmVTb3J0ZWQoKSYmKGU9ZS5zb3J0KGZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUubmFtZT50Lm5hbWU/MTplLm5hbWU8dC5uYW1lPy0xOjB9KSksdGhpcy5tYXAoZSxmdW5jdGlvbihlKXt2YXIgdD10aGlzLm1hcChlLGZ1bmN0aW9uKGUpe3JldHVybltlLnR5cGUsZS5zdWZmaXhlc10uam9pbigifiIpfSkuam9pbigiLCIpO3JldHVybltlLm5hbWUsZS5kZXNjcmlwdGlvbix0XS5qb2luKCI6OiIpfSx0aGlzKX0sZ2V0SUVQbHVnaW5zOmZ1bmN0aW9uKCl7dmFyIGU9W107aWYoT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciYmT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW5kb3csIkFjdGl2ZVhPYmplY3QiKXx8IkFjdGl2ZVhPYmplY3QiaW4gd2luZG93KXtlPXRoaXMubWFwKFsiQWNyb1BERi5QREYiLCJBZG9kYi5TdHJlYW0iLCJBZ0NvbnRyb2wuQWdDb250cm9sIiwiRGV2YWxWUlhDdHJsLkRldmFsVlJYQ3RybC4xIiwiTWFjcm9tZWRpYUZsYXNoUGFwZXIuTWFjcm9tZWRpYUZsYXNoUGFwZXIiLCJNc3htbDIuRE9NRG9jdW1lbnQiLCJNc3htbDIuWE1MSFRUUCIsIlBERi5QZGZDdHJsIiwiUXVpY2tUaW1lLlF1aWNrVGltZSIsIlF1aWNrVGltZUNoZWNrT2JqZWN0LlF1aWNrVGltZUNoZWNrLjEiLCJSZWFsUGxheWVyIiwiUmVhbFBsYXllci5SZWFsUGxheWVyKHRtKSBBY3RpdmVYIENvbnRyb2wgKDMyLWJpdCkiLCJSZWFsVmlkZW8uUmVhbFZpZGVvKHRtKSBBY3RpdmVYIENvbnRyb2wgKDMyLWJpdCkiLCJTY3JpcHRpbmcuRGljdGlvbmFyeSIsIlNXQ3RsLlNXQ3RsIiwiU2hlbGwuVUlIZWxwZXIiLCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaCIsIlNreXBlLkRldGVjdGlvbiIsIlREQ0N0bC5URENDdGwiLCJXTVBsYXllci5PQ1giLCJybW9jeC5SZWFsUGxheWVyIEcyIENvbnRyb2wiLCJybW9jeC5SZWFsUGxheWVyIEcyIENvbnRyb2wuMSJdLGZ1bmN0aW9uKGUpe3RyeXtyZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KGUpLGV9Y2F0Y2goZSl7cmV0dXJuIG51bGx9fSl9cmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zJiYoZT1lLmNvbmNhdCh0aGlzLmdldFJlZ3VsYXJQbHVnaW5zKCkpKSxlfSxwbHVnaW5zU2hvdWxkQmVTb3J0ZWQ6ZnVuY3Rpb24oKXtmb3IodmFyIGU9ITEsdD0wLHI9dGhpcy5vcHRpb25zLnNvcnRQbHVnaW5zRm9yLmxlbmd0aDt0PHI7dCsrKXt2YXIgbj10aGlzLm9wdGlvbnMuc29ydFBsdWdpbnNGb3JbdF07aWYobmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaChuKSl7ZT0hMDticmVha319cmV0dXJuIGV9LHRvdWNoU3VwcG9ydEtleTpmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5vcHRpb25zLmV4Y2x1ZGVUb3VjaFN1cHBvcnR8fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6InRvdWNoX3N1cHBvcnQiLHZhbHVlOnRoaXMuZ2V0VG91Y2hTdXBwb3J0KCl9KSxlfSxoYXJkd2FyZUNvbmN1cnJlbmN5S2V5OmZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLm9wdGlvbnMuZXhjbHVkZUhhcmR3YXJlQ29uY3VycmVuY3l8fGUuYWRkUHJlcHJvY2Vzc2VkQ29tcG9uZW50KHtrZXk6ImhhcmR3YXJlX2NvbmN1cnJlbmN5Iix2YWx1ZTp0aGlzLmdldEhhcmR3YXJlQ29uY3VycmVuY3koKX0pLGV9LGhhc1Nlc3Npb25TdG9yYWdlOmZ1bmN0aW9uKCl7dHJ5e3JldHVybiEhd2luZG93LnNlc3Npb25TdG9yYWdlfWNhdGNoKGUpe3JldHVybiEwfX0saGFzTG9jYWxTdG9yYWdlOmZ1bmN0aW9uKCl7dHJ5e3JldHVybiEhd2luZG93LmxvY2FsU3RvcmFnZX1jYXRjaChlKXtyZXR1cm4hMH19LGhhc0luZGV4ZWREQjpmdW5jdGlvbigpe3RyeXtyZXR1cm4hIXdpbmRvdy5pbmRleGVkREJ9Y2F0Y2goZSl7cmV0dXJuITB9fSxnZXRIYXJkd2FyZUNvbmN1cnJlbmN5OmZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5P25hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5OiJ1bmtub3duIn0sZ2V0TmF2aWdhdG9yQ3B1Q2xhc3M6ZnVuY3Rpb24oKXtyZXR1cm4gbmF2aWdhdG9yLmNwdUNsYXNzP25hdmlnYXRvci5jcHVDbGFzczoidW5rbm93biJ9LGdldE5hdmlnYXRvclBsYXRmb3JtOmZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybT9uYXZpZ2F0b3IucGxhdGZvcm06InVua25vd24ifSxnZXREb05vdFRyYWNrOmZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5kb05vdFRyYWNrP25hdmlnYXRvci5kb05vdFRyYWNrOm5hdmlnYXRvci5tc0RvTm90VHJhY2s/bmF2aWdhdG9yLm1zRG9Ob3RUcmFjazp3aW5kb3cuZG9Ob3RUcmFjaz93aW5kb3cuZG9Ob3RUcmFjazoidW5rbm93biJ9LGdldFRvdWNoU3VwcG9ydDpmdW5jdGlvbigpe3ZhciBlPTAsdD0hMTt2b2lkIDAhPT1uYXZpZ2F0b3IubWF4VG91Y2hQb2ludHM/ZT1uYXZpZ2F0b3IubWF4VG91Y2hQb2ludHM6dm9pZCAwIT09bmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHMmJihlPW5hdmlnYXRvci5tc01heFRvdWNoUG9pbnRzKTt0cnl7ZG9jdW1lbnQuY3JlYXRlRXZlbnQoIlRvdWNoRXZlbnQiKSx0PSEwfWNhdGNoKGUpe31yZXR1cm5bZSx0LCJvbnRvdWNoc3RhcnQiaW4gd2luZG93XX0sZ2V0Q2FudmFzRnA6ZnVuY3Rpb24oKXt2YXIgZT1bXSx0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpO3Qud2lkdGg9MmUzLHQuaGVpZ2h0PTIwMCx0LnN0eWxlLmRpc3BsYXk9ImlubGluZSI7dmFyIHI9dC5nZXRDb250ZXh0KCIyZCIpO3JldHVybiByLnJlY3QoMCwwLDEwLDEwKSxyLnJlY3QoMiwyLDYsNiksZS5wdXNoKCJjYW52YXMgd2luZGluZzoiKyghMT09PXIuaXNQb2ludEluUGF0aCg1LDUsImV2ZW5vZGQiKT8ieWVzIjoibm8iKSksci50ZXh0QmFzZWxpbmU9ImFscGhhYmV0aWMiLHIuZmlsbFN0eWxlPSIjZjYwIixyLmZpbGxSZWN0KDEyNSwxLDYyLDIwKSxyLmZpbGxTdHlsZT0iIzA2OSIsdGhpcy5vcHRpb25zLmRvbnRVc2VGYWtlRm9udEluQ2FudmFzP3IuZm9udD0iMTFwdCBBcmlhbCI6ci5mb250PSIxMXB0IG5vLXJlYWwtZm9udC0xMjMiLHIuZmlsbFRleHQoIkN3bSBmam9yZGJhbmsgZ2x5cGhzIHZleHQgcXVpeiwgXHVkODNkXHVkZTAzIiwyLDE1KSxyLmZpbGxTdHlsZT0icmdiYSgxMDIsIDIwNCwgMCwgMC4yKSIsci5mb250PSIxOHB0IEFyaWFsIixyLmZpbGxUZXh0KCJDd20gZmpvcmRiYW5rIGdseXBocyB2ZXh0IHF1aXosIFx1ZDgzZFx1ZGUwMyIsNCw0NSksci5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb249Im11bHRpcGx5IixyLmZpbGxTdHlsZT0icmdiKDI1NSwwLDI1NSkiLHIuYmVnaW5QYXRoKCksci5hcmMoNTAsNTAsNTAsMCwyKk1hdGguUEksITApLHIuY2xvc2VQYXRoKCksci5maWxsKCksci5maWxsU3R5bGU9InJnYigwLDI1NSwyNTUpIixyLmJlZ2luUGF0aCgpLHIuYXJjKDEwMCw1MCw1MCwwLDIqTWF0aC5QSSwhMCksci5jbG9zZVBhdGgoKSxyLmZpbGwoKSxyLmZpbGxTdHlsZT0icmdiKDI1NSwyNTUsMCkiLHIuYmVnaW5QYXRoKCksci5hcmMoNzUsMTAwLDUwLDAsMipNYXRoLlBJLCEwKSxyLmNsb3NlUGF0aCgpLHIuZmlsbCgpLHIuZmlsbFN0eWxlPSJyZ2IoMjU1LDAsMjU1KSIsci5hcmMoNzUsNzUsNzUsMCwyKk1hdGguUEksITApLHIuYXJjKDc1LDc1LDI1LDAsMipNYXRoLlBJLCEwKSxyLmZpbGwoImV2ZW5vZGQiKSx0LnRvRGF0YVVSTCYmZS5wdXNoKCJjYW52YXMgZnA6Iit0LnRvRGF0YVVSTCgpKSxlLmpvaW4oIn4iKX0sZ2V0V2ViZ2xGcDpmdW5jdGlvbigpe3ZhciBlLHQ9ZnVuY3Rpb24odCl7cmV0dXJuIGUuY2xlYXJDb2xvcigwLDAsMCwxKSxlLmVuYWJsZShlLkRFUFRIX1RFU1QpLGUuZGVwdGhGdW5jKGUuTEVRVUFMKSxlLmNsZWFyKGUuQ09MT1JfQlVGRkVSX0JJVHxlLkRFUFRIX0JVRkZFUl9CSVQpLCJbIit0WzBdKyIsICIrdFsxXSsiXSJ9O2lmKCEoZT10aGlzLmdldFdlYmdsQ2FudmFzKCkpKXJldHVybiBudWxsO3ZhciByPVtdLG49ZS5jcmVhdGVCdWZmZXIoKTtlLmJpbmRCdWZmZXIoZS5BUlJBWV9CVUZGRVIsbik7dmFyIGk9bmV3IEZsb2F0MzJBcnJheShbLS4yLC0uOSwwLC40LC0uMjYsMCwwLC43MzIxMzQ0NDQsMF0pO2UuYnVmZmVyRGF0YShlLkFSUkFZX0JVRkZFUixpLGUuU1RBVElDX0RSQVcpLG4uaXRlbVNpemU9MyxuLm51bUl0ZW1zPTM7dmFyIGE9ZS5jcmVhdGVQcm9ncmFtKCksbz1lLmNyZWF0ZVNoYWRlcihlLlZFUlRFWF9TSEFERVIpO2Uuc2hhZGVyU291cmNlKG8sImF0dHJpYnV0ZSB2ZWMyIGF0dHJWZXJ0ZXg7dmFyeWluZyB2ZWMyIHZhcnlpblRleENvb3JkaW5hdGU7dW5pZm9ybSB2ZWMyIHVuaWZvcm1PZmZzZXQ7dm9pZCBtYWluKCl7dmFyeWluVGV4Q29vcmRpbmF0ZT1hdHRyVmVydGV4K3VuaWZvcm1PZmZzZXQ7Z2xfUG9zaXRpb249dmVjNChhdHRyVmVydGV4LDAsMSk7fSIpLGUuY29tcGlsZVNoYWRlcihvKTt2YXIgcz1lLmNyZWF0ZVNoYWRlcihlLkZSQUdNRU5UX1NIQURFUik7ZS5zaGFkZXJTb3VyY2UocywicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7dmFyeWluZyB2ZWMyIHZhcnlpblRleENvb3JkaW5hdGU7dm9pZCBtYWluKCkge2dsX0ZyYWdDb2xvcj12ZWM0KHZhcnlpblRleENvb3JkaW5hdGUsMCwxKTt9IiksZS5jb21waWxlU2hhZGVyKHMpLGUuYXR0YWNoU2hhZGVyKGEsbyksZS5hdHRhY2hTaGFkZXIoYSxzKSxlLmxpbmtQcm9ncmFtKGEpLGUudXNlUHJvZ3JhbShhKSxhLnZlcnRleFBvc0F0dHJpYj1lLmdldEF0dHJpYkxvY2F0aW9uKGEsImF0dHJWZXJ0ZXgiKSxhLm9mZnNldFVuaWZvcm09ZS5nZXRVbmlmb3JtTG9jYXRpb24oYSwidW5pZm9ybU9mZnNldCIpLGUuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoYS52ZXJ0ZXhQb3NBcnJheSksZS52ZXJ0ZXhBdHRyaWJQb2ludGVyKGEudmVydGV4UG9zQXR0cmliLG4uaXRlbVNpemUsZS5GTE9BVCwhMSwwLDApLGUudW5pZm9ybTJmKGEub2Zmc2V0VW5pZm9ybSwxLDEpLGUuZHJhd0FycmF5cyhlLlRSSUFOR0xFX1NUUklQLDAsbi5udW1JdGVtcyk7dHJ5e3IucHVzaChlLmNhbnZhcy50b0RhdGFVUkwoKSl9Y2F0Y2goZSl7fXIucHVzaCgiZXh0ZW5zaW9uczoiKyhlLmdldFN1cHBvcnRlZEV4dGVuc2lvbnMoKXx8W10pLmpvaW4oIjsiKSksci5wdXNoKCJ3ZWJnbCBhbGlhc2VkIGxpbmUgd2lkdGggcmFuZ2U6Iit0KGUuZ2V0UGFyYW1ldGVyKGUuQUxJQVNFRF9MSU5FX1dJRFRIX1JBTkdFKSkpLHIucHVzaCgid2ViZ2wgYWxpYXNlZCBwb2ludCBzaXplIHJhbmdlOiIrdChlLmdldFBhcmFtZXRlcihlLkFMSUFTRURfUE9JTlRfU0laRV9SQU5HRSkpKSxyLnB1c2goIndlYmdsIGFscGhhIGJpdHM6IitlLmdldFBhcmFtZXRlcihlLkFMUEhBX0JJVFMpKSxyLnB1c2goIndlYmdsIGFudGlhbGlhc2luZzoiKyhlLmdldENvbnRleHRBdHRyaWJ1dGVzKCkuYW50aWFsaWFzPyJ5ZXMiOiJubyIpKSxyLnB1c2goIndlYmdsIGJsdWUgYml0czoiK2UuZ2V0UGFyYW1ldGVyKGUuQkxVRV9CSVRTKSksci5wdXNoKCJ3ZWJnbCBkZXB0aCBiaXRzOiIrZS5nZXRQYXJhbWV0ZXIoZS5ERVBUSF9CSVRTKSksci5wdXNoKCJ3ZWJnbCBncmVlbiBiaXRzOiIrZS5nZXRQYXJhbWV0ZXIoZS5HUkVFTl9CSVRTKSksci5wdXNoKCJ3ZWJnbCBtYXggYW5pc290cm9weToiK2Z1bmN0aW9uKGUpe3ZhciB0PWUuZ2V0RXh0ZW5zaW9uKCJFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKXx8ZS5nZXRFeHRlbnNpb24oIldFQktJVF9FWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKXx8ZS5nZXRFeHRlbnNpb24oIk1PWl9FWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMiKTtpZih0KXt2YXIgcj1lLmdldFBhcmFtZXRlcih0Lk1BWF9URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCk7cmV0dXJuIDA9PT1yJiYocj0yKSxyfXJldHVybiBudWxsfShlKSksci5wdXNoKCJ3ZWJnbCBtYXggY29tYmluZWQgdGV4dHVyZSBpbWFnZSB1bml0czoiK2UuZ2V0UGFyYW1ldGVyKGUuTUFYX0NPTUJJTkVEX1RFWFRVUkVfSU1BR0VfVU5JVFMpKSxyLnB1c2goIndlYmdsIG1heCBjdWJlIG1hcCB0ZXh0dXJlIHNpemU6IitlLmdldFBhcmFtZXRlcihlLk1BWF9DVUJFX01BUF9URVhUVVJFX1NJWkUpKSxyLnB1c2goIndlYmdsIG1heCBmcmFnbWVudCB1bmlmb3JtIHZlY3RvcnM6IitlLmdldFBhcmFtZXRlcihlLk1BWF9GUkFHTUVOVF9VTklGT1JNX1ZFQ1RPUlMpKSxyLnB1c2goIndlYmdsIG1heCByZW5kZXIgYnVmZmVyIHNpemU6IitlLmdldFBhcmFtZXRlcihlLk1BWF9SRU5ERVJCVUZGRVJfU0laRSkpLHIucHVzaCgid2ViZ2wgbWF4IHRleHR1cmUgaW1hZ2UgdW5pdHM6IitlLmdldFBhcmFtZXRlcihlLk1BWF9URVhUVVJFX0lNQUdFX1VOSVRTKSksci5wdXNoKCJ3ZWJnbCBtYXggdGV4dHVyZSBzaXplOiIrZS5nZXRQYXJhbWV0ZXIoZS5NQVhfVEVYVFVSRV9TSVpFKSksci5wdXNoKCJ3ZWJnbCBtYXggdmFyeWluZyB2ZWN0b3JzOiIrZS5nZXRQYXJhbWV0ZXIoZS5NQVhfVkFSWUlOR19WRUNUT1JTKSksci5wdXNoKCJ3ZWJnbCBtYXggdmVydGV4IGF0dHJpYnM6IitlLmdldFBhcmFtZXRlcihlLk1BWF9WRVJURVhfQVRUUklCUykpLHIucHVzaCgid2ViZ2wgbWF4IHZlcnRleCB0ZXh0dXJlIGltYWdlIHVuaXRzOiIrZS5nZXRQYXJhbWV0ZXIoZS5NQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFMpKSxyLnB1c2goIndlYmdsIG1heCB2ZXJ0ZXggdW5pZm9ybSB2ZWN0b3JzOiIrZS5nZXRQYXJhbWV0ZXIoZS5NQVhfVkVSVEVYX1VOSUZPUk1fVkVDVE9SUykpLHIucHVzaCgid2ViZ2wgbWF4IHZpZXdwb3J0IGRpbXM6Iit0KGUuZ2V0UGFyYW1ldGVyKGUuTUFYX1ZJRVdQT1JUX0RJTVMpKSksci5wdXNoKCJ3ZWJnbCByZWQgYml0czoiK2UuZ2V0UGFyYW1ldGVyKGUuUkVEX0JJVFMpKSxyLnB1c2goIndlYmdsIHJlbmRlcmVyOiIrZS5nZXRQYXJhbWV0ZXIoZS5SRU5ERVJFUikpLHIucHVzaCgid2ViZ2wgc2hhZGluZyBsYW5ndWFnZSB2ZXJzaW9uOiIrZS5nZXRQYXJhbWV0ZXIoZS5TSEFESU5HX0xBTkdVQUdFX1ZFUlNJT04pKSxyLnB1c2goIndlYmdsIHN0ZW5jaWwgYml0czoiK2UuZ2V0UGFyYW1ldGVyKGUuU1RFTkNJTF9CSVRTKSksci5wdXNoKCJ3ZWJnbCB2ZW5kb3I6IitlLmdldFBhcmFtZXRlcihlLlZFTkRPUikpLHIucHVzaCgid2ViZ2wgdmVyc2lvbjoiK2UuZ2V0UGFyYW1ldGVyKGUuVkVSU0lPTikpO3RyeXt2YXIgbD1lLmdldEV4dGVuc2lvbigiV0VCR0xfZGVidWdfcmVuZGVyZXJfaW5mbyIpO2wmJihyLnB1c2goIndlYmdsIHVubWFza2VkIHZlbmRvcjoiK2UuZ2V0UGFyYW1ldGVyKGwuVU5NQVNLRURfVkVORE9SX1dFQkdMKSksci5wdXNoKCJ3ZWJnbCB1bm1hc2tlZCByZW5kZXJlcjoiK2UuZ2V0UGFyYW1ldGVyKGwuVU5NQVNLRURfUkVOREVSRVJfV0VCR0wpKSl9Y2F0Y2goZSl7fXJldHVybiBlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdD8oci5wdXNoKCJ3ZWJnbCB2ZXJ0ZXggc2hhZGVyIGhpZ2ggZmxvYXQgcHJlY2lzaW9uOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuSElHSF9GTE9BVCkucHJlY2lzaW9uKSxyLnB1c2goIndlYmdsIHZlcnRleCBzaGFkZXIgaGlnaCBmbG9hdCBwcmVjaXNpb24gcmFuZ2VNaW46IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5ISUdIX0ZMT0FUKS5yYW5nZU1pbiksci5wdXNoKCJ3ZWJnbCB2ZXJ0ZXggc2hhZGVyIGhpZ2ggZmxvYXQgcHJlY2lzaW9uIHJhbmdlTWF4OiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuSElHSF9GTE9BVCkucmFuZ2VNYXgpLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBtZWRpdW0gZmxvYXQgcHJlY2lzaW9uOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuTUVESVVNX0ZMT0FUKS5wcmVjaXNpb24pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBtZWRpdW0gZmxvYXQgcHJlY2lzaW9uIHJhbmdlTWluOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuTUVESVVNX0ZMT0FUKS5yYW5nZU1pbiksci5wdXNoKCJ3ZWJnbCB2ZXJ0ZXggc2hhZGVyIG1lZGl1bSBmbG9hdCBwcmVjaXNpb24gcmFuZ2VNYXg6IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5NRURJVU1fRkxPQVQpLnJhbmdlTWF4KSxyLnB1c2goIndlYmdsIHZlcnRleCBzaGFkZXIgbG93IGZsb2F0IHByZWNpc2lvbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLkxPV19GTE9BVCkucHJlY2lzaW9uKSxyLnB1c2goIndlYmdsIHZlcnRleCBzaGFkZXIgbG93IGZsb2F0IHByZWNpc2lvbiByYW5nZU1pbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLkxPV19GTE9BVCkucmFuZ2VNaW4pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBsb3cgZmxvYXQgcHJlY2lzaW9uIHJhbmdlTWF4OiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuTE9XX0ZMT0FUKS5yYW5nZU1heCksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgaGlnaCBmbG9hdCBwcmVjaXNpb246IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLkZSQUdNRU5UX1NIQURFUixlLkhJR0hfRkxPQVQpLnByZWNpc2lvbiksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgaGlnaCBmbG9hdCBwcmVjaXNpb24gcmFuZ2VNaW46IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLkZSQUdNRU5UX1NIQURFUixlLkhJR0hfRkxPQVQpLnJhbmdlTWluKSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBoaWdoIGZsb2F0IHByZWNpc2lvbiByYW5nZU1heDoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuRlJBR01FTlRfU0hBREVSLGUuSElHSF9GTE9BVCkucmFuZ2VNYXgpLHIucHVzaCgid2ViZ2wgZnJhZ21lbnQgc2hhZGVyIG1lZGl1bSBmbG9hdCBwcmVjaXNpb246IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLkZSQUdNRU5UX1NIQURFUixlLk1FRElVTV9GTE9BVCkucHJlY2lzaW9uKSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBtZWRpdW0gZmxvYXQgcHJlY2lzaW9uIHJhbmdlTWluOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5NRURJVU1fRkxPQVQpLnJhbmdlTWluKSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBtZWRpdW0gZmxvYXQgcHJlY2lzaW9uIHJhbmdlTWF4OiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5NRURJVU1fRkxPQVQpLnJhbmdlTWF4KSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBsb3cgZmxvYXQgcHJlY2lzaW9uOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5MT1dfRkxPQVQpLnByZWNpc2lvbiksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgbG93IGZsb2F0IHByZWNpc2lvbiByYW5nZU1pbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuRlJBR01FTlRfU0hBREVSLGUuTE9XX0ZMT0FUKS5yYW5nZU1pbiksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgbG93IGZsb2F0IHByZWNpc2lvbiByYW5nZU1heDoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuRlJBR01FTlRfU0hBREVSLGUuTE9XX0ZMT0FUKS5yYW5nZU1heCksci5wdXNoKCJ3ZWJnbCB2ZXJ0ZXggc2hhZGVyIGhpZ2ggaW50IHByZWNpc2lvbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLkhJR0hfSU5UKS5wcmVjaXNpb24pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBoaWdoIGludCBwcmVjaXNpb24gcmFuZ2VNaW46IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5ISUdIX0lOVCkucmFuZ2VNaW4pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBoaWdoIGludCBwcmVjaXNpb24gcmFuZ2VNYXg6IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5ISUdIX0lOVCkucmFuZ2VNYXgpLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBtZWRpdW0gaW50IHByZWNpc2lvbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLk1FRElVTV9JTlQpLnByZWNpc2lvbiksci5wdXNoKCJ3ZWJnbCB2ZXJ0ZXggc2hhZGVyIG1lZGl1bSBpbnQgcHJlY2lzaW9uIHJhbmdlTWluOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5WRVJURVhfU0hBREVSLGUuTUVESVVNX0lOVCkucmFuZ2VNaW4pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBtZWRpdW0gaW50IHByZWNpc2lvbiByYW5nZU1heDoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLk1FRElVTV9JTlQpLnJhbmdlTWF4KSxyLnB1c2goIndlYmdsIHZlcnRleCBzaGFkZXIgbG93IGludCBwcmVjaXNpb246IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5MT1dfSU5UKS5wcmVjaXNpb24pLHIucHVzaCgid2ViZ2wgdmVydGV4IHNoYWRlciBsb3cgaW50IHByZWNpc2lvbiByYW5nZU1pbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuVkVSVEVYX1NIQURFUixlLkxPV19JTlQpLnJhbmdlTWluKSxyLnB1c2goIndlYmdsIHZlcnRleCBzaGFkZXIgbG93IGludCBwcmVjaXNpb24gcmFuZ2VNYXg6IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLlZFUlRFWF9TSEFERVIsZS5MT1dfSU5UKS5yYW5nZU1heCksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgaGlnaCBpbnQgcHJlY2lzaW9uOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5ISUdIX0lOVCkucHJlY2lzaW9uKSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBoaWdoIGludCBwcmVjaXNpb24gcmFuZ2VNaW46IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLkZSQUdNRU5UX1NIQURFUixlLkhJR0hfSU5UKS5yYW5nZU1pbiksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgaGlnaCBpbnQgcHJlY2lzaW9uIHJhbmdlTWF4OiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5ISUdIX0lOVCkucmFuZ2VNYXgpLHIucHVzaCgid2ViZ2wgZnJhZ21lbnQgc2hhZGVyIG1lZGl1bSBpbnQgcHJlY2lzaW9uOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5NRURJVU1fSU5UKS5wcmVjaXNpb24pLHIucHVzaCgid2ViZ2wgZnJhZ21lbnQgc2hhZGVyIG1lZGl1bSBpbnQgcHJlY2lzaW9uIHJhbmdlTWluOiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5NRURJVU1fSU5UKS5yYW5nZU1pbiksci5wdXNoKCJ3ZWJnbCBmcmFnbWVudCBzaGFkZXIgbWVkaXVtIGludCBwcmVjaXNpb24gcmFuZ2VNYXg6IitlLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdChlLkZSQUdNRU5UX1NIQURFUixlLk1FRElVTV9JTlQpLnJhbmdlTWF4KSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBsb3cgaW50IHByZWNpc2lvbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuRlJBR01FTlRfU0hBREVSLGUuTE9XX0lOVCkucHJlY2lzaW9uKSxyLnB1c2goIndlYmdsIGZyYWdtZW50IHNoYWRlciBsb3cgaW50IHByZWNpc2lvbiByYW5nZU1pbjoiK2UuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KGUuRlJBR01FTlRfU0hBREVSLGUuTE9XX0lOVCkucmFuZ2VNaW4pLHIucHVzaCgid2ViZ2wgZnJhZ21lbnQgc2hhZGVyIGxvdyBpbnQgcHJlY2lzaW9uIHJhbmdlTWF4OiIrZS5nZXRTaGFkZXJQcmVjaXNpb25Gb3JtYXQoZS5GUkFHTUVOVF9TSEFERVIsZS5MT1dfSU5UKS5yYW5nZU1heCksci5qb2luKCJ+IikpOnIuam9pbigifiIpfSxnZXRXZWJnbFZlbmRvckFuZFJlbmRlcmVyOmZ1bmN0aW9uKCl7dHJ5e3ZhciBlPXRoaXMuZ2V0V2ViZ2xDYW52YXMoKSx0PWUuZ2V0RXh0ZW5zaW9uKCJXRUJHTF9kZWJ1Z19yZW5kZXJlcl9pbmZvIik7cmV0dXJuIGUuZ2V0UGFyYW1ldGVyKHQuVU5NQVNLRURfVkVORE9SX1dFQkdMKSsifiIrZS5nZXRQYXJhbWV0ZXIodC5VTk1BU0tFRF9SRU5ERVJFUl9XRUJHTCl9Y2F0Y2goZSl7cmV0dXJuIG51bGx9fSxnZXRBZEJsb2NrOmZ1bmN0aW9uKCl7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7ZS5pbm5lckhUTUw9IiZuYnNwOyIsZS5jbGFzc05hbWU9ImFkc2JveCI7dmFyIHQ9ITE7dHJ5e2RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSksdD0wPT09ZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiYWRzYm94IilbMF0ub2Zmc2V0SGVpZ2h0LGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZSl9Y2F0Y2goZSl7dD0hMX1yZXR1cm4gdH0sZ2V0SGFzTGllZExhbmd1YWdlczpmdW5jdGlvbigpe2lmKHZvaWQgMCE9PW5hdmlnYXRvci5sYW5ndWFnZXMpdHJ5e2lmKG5hdmlnYXRvci5sYW5ndWFnZXNbMF0uc3Vic3RyKDAsMikhPT1uYXZpZ2F0b3IubGFuZ3VhZ2Uuc3Vic3RyKDAsMikpcmV0dXJuITB9Y2F0Y2goZSl7cmV0dXJuITB9cmV0dXJuITF9LGdldEhhc0xpZWRSZXNvbHV0aW9uOmZ1bmN0aW9uKCl7cmV0dXJuIHdpbmRvdy5zY3JlZW4ud2lkdGg8d2luZG93LnNjcmVlbi5hdmFpbFdpZHRofHx3aW5kb3cuc2NyZWVuLmhlaWdodDx3aW5kb3cuc2NyZWVuLmF2YWlsSGVpZ2h0fSxnZXRIYXNMaWVkT3M6ZnVuY3Rpb24oKXt2YXIgZSx0PW5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSxyPW5hdmlnYXRvci5vc2NwdSxuPW5hdmlnYXRvci5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpO2lmKGU9dC5pbmRleE9mKCJ3aW5kb3dzIHBob25lIik+PTA/IldpbmRvd3MgUGhvbmUiOnQuaW5kZXhPZigid2luIik+PTA/IldpbmRvd3MiOnQuaW5kZXhPZigiYW5kcm9pZCIpPj0wPyJBbmRyb2lkIjp0LmluZGV4T2YoImxpbnV4Iik+PTA/IkxpbnV4Ijp0LmluZGV4T2YoImlwaG9uZSIpPj0wfHx0LmluZGV4T2YoImlwYWQiKT49MD8iaU9TIjp0LmluZGV4T2YoIm1hYyIpPj0wPyJNYWMiOiJPdGhlciIsKCJvbnRvdWNoc3RhcnQiaW4gd2luZG93fHxuYXZpZ2F0b3IubWF4VG91Y2hQb2ludHM+MHx8bmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHM+MCkmJiJXaW5kb3dzIFBob25lIiE9PWUmJiJBbmRyb2lkIiE9PWUmJiJpT1MiIT09ZSYmIk90aGVyIiE9PWUpcmV0dXJuITA7aWYodm9pZCAwIT09cil7aWYoKHI9ci50b0xvd2VyQ2FzZSgpKS5pbmRleE9mKCJ3aW4iKT49MCYmIldpbmRvd3MiIT09ZSYmIldpbmRvd3MgUGhvbmUiIT09ZSlyZXR1cm4hMDtpZihyLmluZGV4T2YoImxpbnV4Iik+PTAmJiJMaW51eCIhPT1lJiYiQW5kcm9pZCIhPT1lKXJldHVybiEwO2lmKHIuaW5kZXhPZigibWFjIik+PTAmJiJNYWMiIT09ZSYmImlPUyIhPT1lKXJldHVybiEwO2lmKCgtMT09PXIuaW5kZXhPZigid2luIikmJi0xPT09ci5pbmRleE9mKCJsaW51eCIpJiYtMT09PXIuaW5kZXhPZigibWFjIikpIT0oIk90aGVyIj09PWUpKXJldHVybiEwfXJldHVybiBuLmluZGV4T2YoIndpbiIpPj0wJiYiV2luZG93cyIhPT1lJiYiV2luZG93cyBQaG9uZSIhPT1lfHwoKG4uaW5kZXhPZigibGludXgiKT49MHx8bi5pbmRleE9mKCJhbmRyb2lkIik+PTB8fG4uaW5kZXhPZigicGlrZSIpPj0wKSYmIkxpbnV4IiE9PWUmJiJBbmRyb2lkIiE9PWV8fCgobi5pbmRleE9mKCJtYWMiKT49MHx8bi5pbmRleE9mKCJpcGFkIik+PTB8fG4uaW5kZXhPZigiaXBvZCIpPj0wfHxuLmluZGV4T2YoImlwaG9uZSIpPj0wKSYmIk1hYyIhPT1lJiYiaU9TIiE9PWV8fCgoLTE9PT1uLmluZGV4T2YoIndpbiIpJiYtMT09PW4uaW5kZXhPZigibGludXgiKSYmLTE9PT1uLmluZGV4T2YoIm1hYyIpKSE9KCJPdGhlciI9PT1lKXx8dm9pZCAwPT09bmF2aWdhdG9yLnBsdWdpbnMmJiJXaW5kb3dzIiE9PWUmJiJXaW5kb3dzIFBob25lIiE9PWUpKSl9LGdldEhhc0xpZWRCcm93c2VyOmZ1bmN0aW9uKCl7dmFyIGUsdD1uYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkscj1uYXZpZ2F0b3IucHJvZHVjdFN1YjtpZigoIkNocm9tZSI9PT0oZT10LmluZGV4T2YoImZpcmVmb3giKT49MD8iRmlyZWZveCI6dC5pbmRleE9mKCJvcGVyYSIpPj0wfHx0LmluZGV4T2YoIm9wciIpPj0wPyJPcGVyYSI6dC5pbmRleE9mKCJjaHJvbWUiKT49MD8iQ2hyb21lIjp0LmluZGV4T2YoInNhZmFyaSIpPj0wPyJTYWZhcmkiOnQuaW5kZXhPZigidHJpZGVudCIpPj0wPyJJbnRlcm5ldCBFeHBsb3JlciI6Ik90aGVyIil8fCJTYWZhcmkiPT09ZXx8Ik9wZXJhIj09PWUpJiYiMjAwMzAxMDciIT09cilyZXR1cm4hMDt2YXIgbixpPWV2YWwudG9TdHJpbmcoKS5sZW5ndGg7aWYoMzc9PT1pJiYiU2FmYXJpIiE9PWUmJiJGaXJlZm94IiE9PWUmJiJPdGhlciIhPT1lKXJldHVybiEwO2lmKDM5PT09aSYmIkludGVybmV0IEV4cGxvcmVyIiE9PWUmJiJPdGhlciIhPT1lKXJldHVybiEwO2lmKDMzPT09aSYmIkNocm9tZSIhPT1lJiYiT3BlcmEiIT09ZSYmIk90aGVyIiE9PWUpcmV0dXJuITA7dHJ5e3Rocm93ImEifWNhdGNoKGUpe3RyeXtlLnRvU291cmNlKCksbj0hMH1jYXRjaChlKXtuPSExfX1yZXR1cm4hKCFufHwiRmlyZWZveCI9PT1lfHwiT3RoZXIiPT09ZSl9LGlzQ2FudmFzU3VwcG9ydGVkOmZ1bmN0aW9uKCl7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7cmV0dXJuISghZS5nZXRDb250ZXh0fHwhZS5nZXRDb250ZXh0KCIyZCIpKX0saXNXZWJHbFN1cHBvcnRlZDpmdW5jdGlvbigpe2lmKCF0aGlzLmlzQ2FudmFzU3VwcG9ydGVkKCkpcmV0dXJuITE7dmFyIGU9dGhpcy5nZXRXZWJnbENhbnZhcygpO3JldHVybiEhd2luZG93LldlYkdMUmVuZGVyaW5nQ29udGV4dCYmISFlfSxpc0lFOmZ1bmN0aW9uKCl7cmV0dXJuIk1pY3Jvc29mdCBJbnRlcm5ldCBFeHBsb3JlciI9PT1uYXZpZ2F0b3IuYXBwTmFtZXx8ISgiTmV0c2NhcGUiIT09bmF2aWdhdG9yLmFwcE5hbWV8fCEvVHJpZGVudC8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSl9LGhhc1N3Zk9iamVjdExvYWRlZDpmdW5jdGlvbigpe3JldHVybiB2b2lkIDAhPT13aW5kb3cuc3dmb2JqZWN0fSxoYXNNaW5GbGFzaEluc3RhbGxlZDpmdW5jdGlvbigpe3JldHVybiB3aW5kb3cuc3dmb2JqZWN0Lmhhc0ZsYXNoUGxheWVyVmVyc2lvbigiOS4wLjAiKX0sYWRkRmxhc2hEaXZOb2RlOmZ1bmN0aW9uKCl7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7ZS5zZXRBdHRyaWJ1dGUoImlkIix0aGlzLm9wdGlvbnMuc3dmQ29udGFpbmVySWQpLGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZSl9LGxvYWRTd2ZBbmREZXRlY3RGb250czpmdW5jdGlvbihlKXt2YXIgdD0iX19fZnBfc3dmX2xvYWRlZCI7d2luZG93W3RdPWZ1bmN0aW9uKHQpe2UodCl9O3ZhciByPXRoaXMub3B0aW9ucy5zd2ZDb250YWluZXJJZDt0aGlzLmFkZEZsYXNoRGl2Tm9kZSgpO3ZhciBuPXtvblJlYWR5OnR9O3dpbmRvdy5zd2ZvYmplY3QuZW1iZWRTV0YodGhpcy5vcHRpb25zLnN3ZlBhdGgsciwiMSIsIjEiLCI5LjAuMCIsITEsbix7YWxsb3dTY3JpcHRBY2Nlc3M6ImFsd2F5cyIsbWVudToiZmFsc2UifSx7fSl9LGdldFdlYmdsQ2FudmFzOmZ1bmN0aW9uKCl7dmFyIGU9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksdD1udWxsO3RyeXt0PWUuZ2V0Q29udGV4dCgid2ViZ2wiKXx8ZS5nZXRDb250ZXh0KCJleHBlcmltZW50YWwtd2ViZ2wiKX1jYXRjaChlKXt9cmV0dXJuIHR8fCh0PW51bGwpLHR9LGVhY2g6ZnVuY3Rpb24oZSx0LHIpe2lmKG51bGwhPT1lKWlmKHRoaXMubmF0aXZlRm9yRWFjaCYmZS5mb3JFYWNoPT09dGhpcy5uYXRpdmVGb3JFYWNoKWUuZm9yRWFjaCh0LHIpO2Vsc2UgaWYoZS5sZW5ndGg9PT0rZS5sZW5ndGgpe2Zvcih2YXIgbj0wLGk9ZS5sZW5ndGg7bjxpO24rKylpZih0LmNhbGwocixlW25dLG4sZSk9PT17fSlyZXR1cm59ZWxzZSBmb3IodmFyIGEgaW4gZSlpZihlLmhhc093blByb3BlcnR5KGEpJiZ0LmNhbGwocixlW2FdLGEsZSk9PT17fSlyZXR1cm59LG1hcDpmdW5jdGlvbihlLHQscil7dmFyIG49W107cmV0dXJuIG51bGw9PWU/bjp0aGlzLm5hdGl2ZU1hcCYmZS5tYXA9PT10aGlzLm5hdGl2ZU1hcD9lLm1hcCh0LHIpOih0aGlzLmVhY2goZSxmdW5jdGlvbihlLGksYSl7bltuLmxlbmd0aF09dC5jYWxsKHIsZSxpLGEpfSksbil9LHg2NEFkZDpmdW5jdGlvbihlLHQpe2U9W2VbMF0+Pj4xNiw2NTUzNSZlWzBdLGVbMV0+Pj4xNiw2NTUzNSZlWzFdXSx0PVt0WzBdPj4+MTYsNjU1MzUmdFswXSx0WzFdPj4+MTYsNjU1MzUmdFsxXV07dmFyIHI9WzAsMCwwLDBdO3JldHVybiByWzNdKz1lWzNdK3RbM10sclsyXSs9clszXT4+PjE2LHJbM10mPTY1NTM1LHJbMl0rPWVbMl0rdFsyXSxyWzFdKz1yWzJdPj4+MTYsclsyXSY9NjU1MzUsclsxXSs9ZVsxXSt0WzFdLHJbMF0rPXJbMV0+Pj4xNixyWzFdJj02NTUzNSxyWzBdKz1lWzBdK3RbMF0sclswXSY9NjU1MzUsW3JbMF08PDE2fHJbMV0sclsyXTw8MTZ8clszXV19LHg2NE11bHRpcGx5OmZ1bmN0aW9uKGUsdCl7ZT1bZVswXT4+PjE2LDY1NTM1JmVbMF0sZVsxXT4+PjE2LDY1NTM1JmVbMV1dLHQ9W3RbMF0+Pj4xNiw2NTUzNSZ0WzBdLHRbMV0+Pj4xNiw2NTUzNSZ0WzFdXTt2YXIgcj1bMCwwLDAsMF07cmV0dXJuIHJbM10rPWVbM10qdFszXSxyWzJdKz1yWzNdPj4+MTYsclszXSY9NjU1MzUsclsyXSs9ZVsyXSp0WzNdLHJbMV0rPXJbMl0+Pj4xNixyWzJdJj02NTUzNSxyWzJdKz1lWzNdKnRbMl0sclsxXSs9clsyXT4+PjE2LHJbMl0mPTY1NTM1LHJbMV0rPWVbMV0qdFszXSxyWzBdKz1yWzFdPj4+MTYsclsxXSY9NjU1MzUsclsxXSs9ZVsyXSp0WzJdLHJbMF0rPXJbMV0+Pj4xNixyWzFdJj02NTUzNSxyWzFdKz1lWzNdKnRbMV0sclswXSs9clsxXT4+PjE2LHJbMV0mPTY1NTM1LHJbMF0rPWVbMF0qdFszXStlWzFdKnRbMl0rZVsyXSp0WzFdK2VbM10qdFswXSxyWzBdJj02NTUzNSxbclswXTw8MTZ8clsxXSxyWzJdPDwxNnxyWzNdXX0seDY0Um90bDpmdW5jdGlvbihlLHQpe3JldHVybiAzMj09PSh0JT02NCk/W2VbMV0sZVswXV06dDwzMj9bZVswXTw8dHxlWzFdPj4+MzItdCxlWzFdPDx0fGVbMF0+Pj4zMi10XToodC09MzIsW2VbMV08PHR8ZVswXT4+PjMyLXQsZVswXTw8dHxlWzFdPj4+MzItdF0pfSx4NjRMZWZ0U2hpZnQ6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gMD09PSh0JT02NCk/ZTp0PDMyP1tlWzBdPDx0fGVbMV0+Pj4zMi10LGVbMV08PHRdOltlWzFdPDx0LTMyLDBdfSx4NjRYb3I6ZnVuY3Rpb24oZSx0KXtyZXR1cm5bZVswXV50WzBdLGVbMV1edFsxXV19LHg2NEZtaXg6ZnVuY3Rpb24oZSl7cmV0dXJuIGU9dGhpcy54NjRYb3IoZSxbMCxlWzBdPj4+MV0pLGU9dGhpcy54NjRNdWx0aXBseShlLFs0MjgzNTQzNTExLDM5ODE4MDY3OTddKSxlPXRoaXMueDY0WG9yKGUsWzAsZVswXT4+PjFdKSxlPXRoaXMueDY0TXVsdGlwbHkoZSxbMzMwMTg4MjM2Niw0NDQ5ODQ0MDNdKSxlPXRoaXMueDY0WG9yKGUsWzAsZVswXT4+PjFdKX0seDY0aGFzaDEyODpmdW5jdGlvbihlLHQpe2U9ZXx8IiIsdD10fHwwO2Zvcih2YXIgcj1lLmxlbmd0aCUxNixuPWUubGVuZ3RoLXIsaT1bMCx0XSxhPVswLHRdLG89WzAsMF0scz1bMCwwXSxsPVsyMjc3NzM1MzEzLDI4OTU1OTUwOV0sZD1bMTI5MTE2OTA5MSw2NTg4NzExNjddLGg9MDtoPG47aCs9MTYpbz1bMjU1JmUuY2hhckNvZGVBdChoKzQpfCgyNTUmZS5jaGFyQ29kZUF0KGgrNSkpPDw4fCgyNTUmZS5jaGFyQ29kZUF0KGgrNikpPDwxNnwoMjU1JmUuY2hhckNvZGVBdChoKzcpKTw8MjQsMjU1JmUuY2hhckNvZGVBdChoKXwoMjU1JmUuY2hhckNvZGVBdChoKzEpKTw8OHwoMjU1JmUuY2hhckNvZGVBdChoKzIpKTw8MTZ8KDI1NSZlLmNoYXJDb2RlQXQoaCszKSk8PDI0XSxzPVsyNTUmZS5jaGFyQ29kZUF0KGgrMTIpfCgyNTUmZS5jaGFyQ29kZUF0KGgrMTMpKTw8OHwoMjU1JmUuY2hhckNvZGVBdChoKzE0KSk8PDE2fCgyNTUmZS5jaGFyQ29kZUF0KGgrMTUpKTw8MjQsMjU1JmUuY2hhckNvZGVBdChoKzgpfCgyNTUmZS5jaGFyQ29kZUF0KGgrOSkpPDw4fCgyNTUmZS5jaGFyQ29kZUF0KGgrMTApKTw8MTZ8KDI1NSZlLmNoYXJDb2RlQXQoaCsxMSkpPDwyNF0sbz10aGlzLng2NE11bHRpcGx5KG8sbCksbz10aGlzLng2NFJvdGwobywzMSksbz10aGlzLng2NE11bHRpcGx5KG8sZCksaT10aGlzLng2NFhvcihpLG8pLGk9dGhpcy54NjRSb3RsKGksMjcpLGk9dGhpcy54NjRBZGQoaSxhKSxpPXRoaXMueDY0QWRkKHRoaXMueDY0TXVsdGlwbHkoaSxbMCw1XSksWzAsMTM5MDIwODgwOV0pLHM9dGhpcy54NjRNdWx0aXBseShzLGQpLHM9dGhpcy54NjRSb3RsKHMsMzMpLHM9dGhpcy54NjRNdWx0aXBseShzLGwpLGE9dGhpcy54NjRYb3IoYSxzKSxhPXRoaXMueDY0Um90bChhLDMxKSxhPXRoaXMueDY0QWRkKGEsaSksYT10aGlzLng2NEFkZCh0aGlzLng2NE11bHRpcGx5KGEsWzAsNV0pLFswLDk0NDMzMTQ0NV0pO3N3aXRjaChvPVswLDBdLHM9WzAsMF0scil7Y2FzZSAxNTpzPXRoaXMueDY0WG9yKHMsdGhpcy54NjRMZWZ0U2hpZnQoWzAsZS5jaGFyQ29kZUF0KGgrMTQpXSw0OCkpO2Nhc2UgMTQ6cz10aGlzLng2NFhvcihzLHRoaXMueDY0TGVmdFNoaWZ0KFswLGUuY2hhckNvZGVBdChoKzEzKV0sNDApKTtjYXNlIDEzOnM9dGhpcy54NjRYb3Iocyx0aGlzLng2NExlZnRTaGlmdChbMCxlLmNoYXJDb2RlQXQoaCsxMildLDMyKSk7Y2FzZSAxMjpzPXRoaXMueDY0WG9yKHMsdGhpcy54NjRMZWZ0U2hpZnQoWzAsZS5jaGFyQ29kZUF0KGgrMTEpXSwyNCkpO2Nhc2UgMTE6cz10aGlzLng2NFhvcihzLHRoaXMueDY0TGVmdFNoaWZ0KFswLGUuY2hhckNvZGVBdChoKzEwKV0sMTYpKTtjYXNlIDEwOnM9dGhpcy54NjRYb3Iocyx0aGlzLng2NExlZnRTaGlmdChbMCxlLmNoYXJDb2RlQXQoaCs5KV0sOCkpO2Nhc2UgOTpzPXRoaXMueDY0WG9yKHMsWzAsZS5jaGFyQ29kZUF0KGgrOCldKSxzPXRoaXMueDY0TXVsdGlwbHkocyxkKSxzPXRoaXMueDY0Um90bChzLDMzKSxzPXRoaXMueDY0TXVsdGlwbHkocyxsKSxhPXRoaXMueDY0WG9yKGEscyk7Y2FzZSA4Om89dGhpcy54NjRYb3Iobyx0aGlzLng2NExlZnRTaGlmdChbMCxlLmNoYXJDb2RlQXQoaCs3KV0sNTYpKTtjYXNlIDc6bz10aGlzLng2NFhvcihvLHRoaXMueDY0TGVmdFNoaWZ0KFswLGUuY2hhckNvZGVBdChoKzYpXSw0OCkpO2Nhc2UgNjpvPXRoaXMueDY0WG9yKG8sdGhpcy54NjRMZWZ0U2hpZnQoWzAsZS5jaGFyQ29kZUF0KGgrNSldLDQwKSk7Y2FzZSA1Om89dGhpcy54NjRYb3Iobyx0aGlzLng2NExlZnRTaGlmdChbMCxlLmNoYXJDb2RlQXQoaCs0KV0sMzIpKTtjYXNlIDQ6bz10aGlzLng2NFhvcihvLHRoaXMueDY0TGVmdFNoaWZ0KFswLGUuY2hhckNvZGVBdChoKzMpXSwyNCkpO2Nhc2UgMzpvPXRoaXMueDY0WG9yKG8sdGhpcy54NjRMZWZ0U2hpZnQoWzAsZS5jaGFyQ29kZUF0KGgrMildLDE2KSk7Y2FzZSAyOm89dGhpcy54NjRYb3Iobyx0aGlzLng2NExlZnRTaGlmdChbMCxlLmNoYXJDb2RlQXQoaCsxKV0sOCkpO2Nhc2UgMTpvPXRoaXMueDY0WG9yKG8sWzAsZS5jaGFyQ29kZUF0KGgpXSksbz10aGlzLng2NE11bHRpcGx5KG8sbCksbz10aGlzLng2NFJvdGwobywzMSksbz10aGlzLng2NE11bHRpcGx5KG8sZCksaT10aGlzLng2NFhvcihpLG8pfXJldHVybiBpPXRoaXMueDY0WG9yKGksWzAsZS5sZW5ndGhdKSxhPXRoaXMueDY0WG9yKGEsWzAsZS5sZW5ndGhdKSxpPXRoaXMueDY0QWRkKGksYSksYT10aGlzLng2NEFkZChhLGkpLGk9dGhpcy54NjRGbWl4KGkpLGE9dGhpcy54NjRGbWl4KGEpLGk9dGhpcy54NjRBZGQoaSxhKSxhPXRoaXMueDY0QWRkKGEsaSksKCIwMDAwMDAwMCIrKGlbMF0+Pj4wKS50b1N0cmluZygxNikpLnNsaWNlKC04KSsoIjAwMDAwMDAwIisoaVsxXT4+PjApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTgpKygiMDAwMDAwMDAiKyhhWzBdPj4+MCkudG9TdHJpbmcoMTYpKS5zbGljZSgtOCkrKCIwMDAwMDAwMCIrKGFbMV0+Pj4wKS50b1N0cmluZygxNikpLnNsaWNlKC04KX19LGUuVkVSU0lPTj0iMS44LjAiLGV9KTs=").'</script>');
			Template::addHeader('<script>new Fingerprint2().get(function(result, components){document.cookie = "posfpv = "+result});</script>');			
		}else{
			setcookie("posfpv","",time()-3600,"/",NULL);
		}
		
		setcookie("posfp", $this->client[3], ($this->cnf[0] ? time() + $this->expire : NULL), "/", ($this->cnf[1] ? $root_domain : NULL));
		setcookie("puzzleos", $this->id, ($this->cnf[0] ? time() + $this->expire : NULL), "/", ($this->cnf[1] ? $root_domain : NULL));
	}

    public function destroy($id){
        //Remove session from database
		Database::deleteRow("sessions","session_id",$id);
		$this->destroyed = true;
		return true;
    }

    public function gc($maxlifetime){
		Database::exec("delete from `sessions` where expire<=?",(int)time());
    }
	
	public function __set($k,$v){
		switch($k){
		case "share_on_subdomain":
			if($this->cnf[1] != $v){
				$this->cnf[1] = (bool) $v;
				$this->c_update = true;
			}
			break;
		case "retain_on_same_pc":
			if($this->cnf[0] != $v){
				$this->cnf[0] = (bool) $v;
				$this->c_update = true;
			}
			break;
		case "expire":
			$this->expire = (int) $v;
			break;
		default:
			throw new PuzzleError("Invalid input $k");
		}
	}
	
	/**
	 * WARNING!
	 * End all active session in PuzzleOS
	 */
	public function endAll(){
		Database::exec("delete from `sessions`");
		$this->destroyed = true;
	}
	
	public function __get($k){
		if($this->destroyed) throw new PuzzleError("Cannot read or write from destroyed session");
		switch($k){
		case "session_id":
			return $this->id;
		default:
			throw new PuzzleError("Invalid input $k");
		}
	}
}

/* Configuring session */
PuzzleOSGlobal::$session = new PuzzleSession;
session_set_save_handler(PuzzleOSGlobal::$session);
ini_set('session.use_cookies', 0); 
session_start();

?>